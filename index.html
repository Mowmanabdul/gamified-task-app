<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuestLog RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0D1117;
            --bg-secondary: rgba(31, 41, 55, 0.7);
            --border-color: rgba(55, 65, 81, 0.7);
            --text-primary: #F3F4F6;
            --text-secondary: #9CA3AF;
            --accent-primary: #3B82F6;
            --accent-secondary: #8B5CF6;
            --accent-gold: #facc15;
            --accent-streak: #f97316;
            --accent-success: #10B981;
            --accent-error: #EF4444;
            --priority-low: #22c55e;
            --priority-medium: #eab308;
            --priority-high: #ef4444;
            --font-body: 'Inter', sans-serif;
            --aurora-1: var(--accent-primary);
            --aurora-2: var(--accent-secondary);
        }

        [data-theme="light"] {
            --bg-primary: #F3F4F6;
            --bg-secondary: rgba(255, 255, 255, 0.7);
            --border-color: rgba(209, 213, 219, 0.7);
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --aurora-1: var(--accent-primary);
            --aurora-2: var(--accent-secondary);
        }

        [data-theme="forest"] {
            --bg-primary: #1A2E2C;
            --bg-secondary: rgba(29, 58, 55, 0.7);
            --border-color: rgba(43, 87, 83, 0.7);
            --text-primary: #E0EBEA;
            --text-secondary: #9DBFBC;
            --accent-primary: #34D399;
            --accent-secondary: #A7F3D0;
            --aurora-1: var(--accent-primary);
            --aurora-2: var(--accent-secondary);
        }
        
        [data-theme="ruby"] {
            --bg-primary: #2c0b0e;
            --bg-secondary: rgba(76, 29, 29, 0.7);
            --border-color: rgba(127, 29, 29, 0.7);
            --text-primary: #fecaca;
            --text-secondary: #fca5a5;
            --accent-primary: #ef4444;
            --accent-secondary: #f87171;
            --aurora-1: var(--accent-primary);
            --aurora-2: #991b1b; /* red-800 */
        }

        [data-theme="emerald"] {
            --bg-primary: #062a15;
            --bg-secondary: rgba(4, 76, 46, 0.7);
            --border-color: rgba(5, 150, 105, 0.7);
            --text-primary: #d1fae5;
            --text-secondary: #a7f3d0;
            --accent-primary: #10b981;
            --accent-secondary: #34d399;
            --aurora-1: var(--accent-primary);
            --aurora-2: #065f46; /* green-800 */
        }

        [data-theme="sapphire"] {
            --bg-primary: #0c1a3e;
            --bg-secondary: rgba(30, 58, 138, 0.7); /* blue-800 */
            --border-color: rgba(30, 64, 175, 0.7); /* blue-700 */
            --text-primary: #dbeafe; /* blue-100 */
            --text-secondary: #93c5fd; /* blue-300 */
            --accent-primary: #0ea5e9; /* sky-500 */
            --accent-secondary: #22d3ee; /* cyan-400 */
            --aurora-1: var(--accent-primary);
            --aurora-2: #155e75; /* cyan-800 */
        }

        [data-theme="amethyst"] {
            --bg-primary: #1e1b4b; /* indigo-950 */
            --bg-secondary: rgba(76, 29, 149, 0.7); /* violet-800 */
            --border-color: rgba(91, 33, 182, 0.7); /* violet-700 */
            --text-primary: #e0e7ff; /* indigo-100 */
            --text-secondary: #c7d2fe; /* indigo-200 */
            --accent-primary: #d946ef; /* fuchsia-500 */
            --accent-secondary: #ec4899; /* pink-500 */
            --aurora-1: var(--accent-primary);
            --aurora-2: #86198f; /* purple-800 */
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        h1, h2, h3, h4 {
            font-weight: 700;
        }
        
        .aurora-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden;
        }
        .aurora-background::before {
            content: ''; position: absolute; top: 50%; left: 50%; width: 1200px; height: 1200px;
            background-image: radial-gradient(circle, var(--aurora-1) 0%, var(--aurora-2) 50%, transparent 70%);
            opacity: 0.3; transform: translate(-50%, -50%); animation: pulse 20s infinite ease-in-out; filter: blur(120px);
            transition: background-image 0.5s ease-in-out;
        }
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-45%, -55%) scale(1.3); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .card-header { border-bottom: 1px solid var(--border-color); }
        
        .btn-interactive:active {
            transform: scale(0.95);
        }

        .progress-bar-bg { background-color: rgba(0,0,0,0.2); }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
        .xp-bar { background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); }
        .skill-bar { background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary)); }
        .gold-text { color: var(--accent-gold); }
        .streak-text { color: var(--accent-streak); }

        .text-accent-primary { color: var(--accent-primary); }
        .text-accent-secondary { color: var(--accent-secondary); }
        
        input, button, select, .bg-themed {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-family: var(--font-body);
        }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { height: 6px; background: var(--border-color); border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; margin-top: -6px; height: 18px; width: 18px; border-radius: 50%; background: var(--accent-primary); cursor: pointer; }
        
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        input[type="checkbox"] { accent-color: var(--accent-primary); }

        .anim-fade-in { animation: fadeInUp 0.5s ease-out forwards; }
        .anim-fade-out { animation: fadeOutShrink 0.4s ease-in forwards; }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOutShrink { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); height: 0; padding: 0; margin: 0; border: 0; } }
        
        .level-up-animation { animation: levelUpPulse 1.5s ease-out; }
        @keyframes levelUpPulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 50% { transform: scale(1.2); box-shadow: 0 0 20px 15px rgba(59, 130, 246, 0); } 100% { transform: scale(1); } }
        
        .toast {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .toast-success { border-left: 4px solid var(--accent-success); }
        .toast-error { border-left: 4px solid var(--accent-error); }
        .toast-levelup { border-left: 4px solid var(--accent-gold); }

        .modal { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .modal.flex { display: flex; }
        .modal.opacity-100 { opacity: 1; }

        .scrollable-content::-webkit-scrollbar { width: 8px; }
        .scrollable-content::-webkit-scrollbar-track { background: transparent; }
        .scrollable-content::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 4px; }
        .scrollable-content { scrollbar-width: thin; scrollbar-color: var(--border-color) transparent; }
        
        #avatar-display { image-rendering: pixelated; }
        .avatar-select-button.selected { border-color: var(--accent-primary); box-shadow: 0 0 10px var(--accent-primary); }

        .tooltip { position: relative; display: inline-block; cursor: pointer; }
        .tooltip .tooltiptext { 
            visibility: hidden; 
            width: auto;
            white-space: nowrap;
            background-color: var(--bg-secondary);
            color: var(--text-primary); 
            text-align: center; 
            border-radius: 6px; 
            padding: 6px 10px; 
            position: absolute; 
            z-index: 10; 
            bottom: 125%; 
            left: 50%; 
            transform: translateX(-50%);
            opacity: 0; 
            transition: opacity 0.3s; 
            border: 1px solid var(--border-color);
            font-size: 0.75rem; 
            line-height: 1.2; 
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        .priority-low { border-left: 4px solid var(--priority-low); }
        .priority-medium { border-left: 4px solid var(--priority-medium); }
        .priority-high { border-left: 4px solid var(--priority-high); }

        .reward-fly-up {
            position: absolute;
            padding: 4px 8px;
            border-radius: 9999px;
            font-weight: bold;
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 100;
            animation: floatAndFade 1.5s ease-out forwards;
        }

        @keyframes floatAndFade {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-80px) scale(0.8); opacity: 0; }
        }

        .card-flash {
            animation: cardFlashPulse 0.8s ease-out;
        }

        @keyframes cardFlashPulse {
            0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7); }
            50% { box-shadow: 0 0 15px 5px rgba(250, 204, 21, 0.3); }
            100% { box-shadow: none; }
        }
        .empty-state-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
            padding: 1.5rem;
            opacity: 0.6;
        }
        .chart-tab.active {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }
        #advanced-options {
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out, margin-top 0.5s ease-in-out;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
        }
        #advanced-options.open {
            max-height: 1000px; /* Large enough to fit content */
            opacity: 1;
            margin-top: 1rem;
        }
        .mobile-tab.active {
            color: var(--accent-primary);
        }

        .quest-complete-flash {
            animation: questCompleteFlash 0.7s ease-out;
        }

        @keyframes questCompleteFlash {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
            50% { box-shadow: 0 0 12px 4px rgba(16, 185, 129, 0.5); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        .journey-item {
            position: relative;
            padding-left: 40px;
            padding-bottom: 2rem;
        }
        .journey-item:last-child {
            padding-bottom: 0;
        }
        .journey-item:last-child::before {
            height: 0;
        }
        /* The vertical line */
        .journey-item::before {
            content: '';
            position: absolute;
            left: 11px;
            top: 5px;
            width: 2px;
            height: 100%;
            background-color: var(--border-color);
            transition: background-color 0.5s ease;
        }
        .journey-icon {
            position: absolute;
            left: 0;
            top: 0;
            width: 24px;
            height: 24px;
            background-color: var(--bg-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        /* Styling based on status */
        .journey-item.completed .journey-icon {
            color: var(--accent-gold);
            border: 2px solid var(--accent-gold);
        }
        .journey-item.completed::before {
            background-color: var(--accent-gold);
        }
        .journey-item.next .journey-icon {
            color: var(--accent-primary);
            border: 2px solid var(--accent-primary);
            animation: pulseIcon 2s infinite ease-in-out;
        }
        .journey-item.locked .journey-icon {
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
        }
        .journey-item.locked .journey-content {
            opacity: 0.6;
        }
        @keyframes pulseIcon {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

    </style>
</head>
<body class="antialiased">
    <div class="aurora-background"></div>
    <div class="container mx-auto p-4 md:p-8 max-w-7xl relative pb-20 lg:pb-8">
        <header class="text-center mb-8 relative">
            <h1 class="text-5xl md:text-6xl tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2">QuestLog</h1>
            <p class="text-lg text-gray-400">Level up your life, one quest at a time.</p>
            <button id="settings-btn" class="absolute top-0 right-0 p-2 rounded-full hover:bg-themed transition">
                <i data-lucide="settings" class="w-6 h-6"></i>
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:items-start">
            <!-- Left Column (Player Dashboard) -->
            <div id="mobile-panel-dashboard" class="space-y-8 lg:col-span-1 hidden lg:block">
                <div id="player-card" class="card p-6 shadow-lg">
                    <div class="grid grid-cols-3 gap-4 items-center">
                        <div class="col-span-1">
                             <div id="avatar-display" class="w-24 h-24 bg-gray-900 rounded-lg overflow-hidden border-2 border-themed mx-auto cursor-pointer bg-cover bg-center"></div>
                             <div id="active-buffs-container" class="flex justify-center items-center gap-2 mt-2 h-6"></div>
                        </div>
                        <div class="col-span-2">
                            <input type="text" id="character-name" class="w-full text-2xl font-bold bg-transparent border-0 border-b-2 border-themed focus:outline-none focus:ring-0 p-1" value="Hero">
                            <p id="character-title" class="text-xs text-center text-yellow-400 font-semibold h-4"></p>
                            <p id="character-class" class="text-sm text-accent-secondary font-semibold capitalize"></p>
                            <div class="mt-2 flex justify-between items-center text-sm font-medium text-gray-300">
                                <span>Level <span id="player-level" class="font-bold">1</span></span>
                                <span id="player-xp-text">0 / 100</span>
                            </div>
                            <div class="w-full progress-bar-bg rounded-full h-4 mt-1 overflow-hidden">
                                <div id="player-xp-bar" class="progress-bar-fill xp-bar h-4 rounded-full" style="width: 0%"></div>
                            </div>
                             <div class="mt-2 flex items-center justify-between">
                                 <div class="flex items-center gap-1"><i data-lucide="coins" class="w-5 h-5 gold-text"></i> <span id="player-gold" class="font-bold gold-text">0 G</span></div>
                                 <div class="flex items-center gap-1"><i data-lucide="flame" class="w-5 h-5 streak-text"></i> <span id="player-streak" class="font-bold streak-text">0</span></div>
                             </div>
                        </div>
                    </div>
                </div>
                 <div class="card p-6 min-h-[200px]">
                    <h2 class="text-2xl mb-4 card-header pb-3">The Hero's Journey</h2>
                    <div id="hero-journey-list" class="scrollable-content pr-2 max-h-72 overflow-y-auto"></div>
                </div>
                 <div class="card p-6 min-h-[200px]">
                    <h2 class="text-2xl mb-4 card-header pb-3">Skills</h2>
                    <div id="skills-list" class="space-y-4 scrollable-content pr-2 max-h-72 overflow-y-auto"></div>
                </div>
                <div class="card p-6">
                    <h2 class="text-2xl mb-4 card-header pb-3">Player Profile & Stats</h2>
                    <div id="player-profile-stats" class="text-sm mb-4"></div>
                    <!-- Chart Tabs -->
                    <div class="mt-4 border-b border-themed flex">
                        <button data-tab="weekly" class="profile-tab chart-tab px-4 py-2 text-sm font-medium border-b-2 active">Weekly</button>
                        <button data-tab="category" class="profile-tab chart-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-text-secondary hover:text-text-primary">Breakdown</button>
                        <button data-tab="insights" class="profile-tab chart-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-text-secondary hover:text-text-primary">Insights</button>
                    </div>
                    <!-- Chart Canvases -->
                    <div id="profile-tab-content-weekly" class="h-48 mt-4 relative">
                        <canvas id="stats-chart"></canvas>
                    </div>
                    <div id="profile-tab-content-category" class="h-48 mt-4 relative" style="display: none;">
                         <canvas id="category-donut-chart"></canvas>
                    </div>
                    <div id="profile-tab-content-insights" class="mt-4" style="display: none;">
                        <div class="space-y-6">
                             <div>
                                <h4 class="text-sm font-semibold mb-2 text-center text-text-secondary">Productivity Heatmap (Last 35 Days)</h4>
                                <div id="productivity-heatmap" class="grid grid-rows-5 grid-flow-col gap-1.5 justify-center p-2 bg-themed rounded-lg"></div>
                            </div>
                            <div class="h-56 relative">
                                <h4 class="text-sm font-semibold mb-2 text-center text-text-secondary">XP Earned per Skill</h4>
                                <canvas id="skill-radar-chart"></canvas>
                            </div>
                             <div class="h-48 relative">
                                <h4 class="text-sm font-semibold mb-2 text-center text-text-secondary">Productivity by Hour of Day</h4>
                                <canvas id="time-of-day-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <button id="quest-log-btn" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition btn-interactive">View Full Log</button>
                </div>
            </div>

            <!-- Middle Column (Quest Hub) -->
            <div id="mobile-panel-quests" class="space-y-8 lg:col-span-1 block lg:block">
                <div class="card p-6">
                    <h2 class="text-2xl mb-4 card-header pb-3">Add New Quest</h2>
                    <form id="add-task-form" class="space-y-4">
                        <input type="text" id="task-name" required placeholder="What's your next quest?" class="w-full p-3 bg-themed rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="task-category" list="skill-suggestions" required placeholder="Skill / Category (e.g., Fitness)" class="w-full p-3 bg-themed rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <datalist id="skill-suggestions"></datalist>
                        <div>
                            <label for="task-xp" class="block text-sm font-medium mb-2">XP Reward</label>
                            <div class="flex items-center gap-4">
                               <input type="range" id="task-xp" min="10" max="500" step="10" value="50" class="w-full">
                               <span id="task-xp-value" class="font-bold text-accent-primary w-16 text-center">50 XP</span>
                            </div>
                        </div>

                        <button type="button" id="toggle-advanced-btn" class="w-full text-sm text-center text-accent-primary hover:underline">Show Advanced Options</button>
                        
                        <div id="advanced-options" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="task-priority" class="block text-sm font-medium mb-2">Priority</label>
                                    <select id="task-priority" class="w-full p-3 bg-themed rounded-lg">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="task-due-date" class="block text-sm font-medium mb-2">Due Date (Optional)</label>
                                    <input type="date" id="task-due-date" class="w-full p-3 bg-themed rounded-lg">
                                </div>
                            </div>
                             <div>
                                <label for="task-recurrence" class="block text-sm font-medium mb-2">Recurrence</label>
                                <select id="task-recurrence" class="w-full p-3 bg-themed rounded-lg">
                                    <option value="none">None (One-time quest)</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div id="recurrence-options" class="space-y-2"></div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Sub-quests (Checklist)</label>
                                <div class="flex gap-2 mb-2">
                                    <input type="text" id="subtask-name" placeholder="Add a smaller step..." class="w-full p-2 bg-themed rounded-lg">
                                    <button type="button" id="add-subtask-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold p-2 rounded-lg transition transform hover:scale-110 btn-interactive">+</button>
                                </div>
                                <div id="subtasks-container" class="space-y-2 max-h-28 overflow-y-auto scrollable-content pr-2"></div>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105 btn-interactive">Embark on Quest</button>
                    </form>
                </div>
                <div id="bounty-board-card" class="card p-6 min-h-[200px]"></div>
                <div class="card p-6 min-h-[200px]">
                    <div class="flex justify-between items-center card-header pb-3">
                        <h2 class="text-2xl">Active Quests</h2>
                    </div>
                     <div class="flex flex-col sm:flex-row gap-2 my-4">
                         <div class="flex-grow">
                             <label for="filter-category" class="sr-only">Filter by Category</label>
                             <select id="filter-category" class="w-full p-2 text-sm bg-themed rounded-lg">
                                 <option value="all">All Categories</option>
                             </select>
                         </div>
                         <div class="flex-grow">
                             <label for="sort-tasks" class="sr-only">Sort Quests</label>
                             <select id="sort-tasks" class="w-full p-2 text-sm bg-themed rounded-lg">
                                 <option value="id-desc">Date Added (Newest)</option>
                                 <option value="id-asc">Date Added (Oldest)</option>
                                 <option value="priority-desc">Priority (High to Low)</option>
                                 <option value="priority-asc">Priority (Low to High)</option>
                                 <option value="due-date-asc">Due Date (Soonest)</option>
                                 <option value="xp-desc">XP (Highest)</option>
                             </select>
                         </div>
                     </div>
                    <div id="task-list" class="space-y-3 scrollable-content pr-2 max-h-72 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Right Column (Rewards & System) -->
            <div id="mobile-panel-shop" class="space-y-8 lg:col-span-1 hidden lg:block">
                <div class="card p-6 flex flex-col h-full min-h-[500px]">
                    <h2 class="text-2xl mb-4 card-header pb-3">Freedom Shop</h2>
                    
                    <div id="black-market-section"></div>

                    <h3 class="text-lg mb-2 mt-4 border-t border-themed pt-4">Your Permanent Rewards</h3>
                    <div id="shop-list" class="space-y-3 mb-6 scrollable-content pr-2 max-h-48 overflow-y-auto"></div>
                    
                    <h3 class="text-lg mb-2 mt-auto">Add New Permanent Reward</h3>
                    <form id="add-reward-form" class="space-y-2">
                        <div>
                            <input type="text" id="reward-name" required placeholder="Reward name" class="w-full p-2 bg-themed rounded-lg">
                        </div>
                        <div class="flex gap-2">
                           <input type="number" id="reward-cost" min="1" required placeholder="Cost" class="w-full p-2 bg-themed rounded-lg">
                           <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold p-2 rounded-lg transition transform hover:scale-110 btn-interactive">+</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Tab Bar -->
    <div id="mobile-tab-bar" class="lg:hidden fixed bottom-0 left-0 right-0 h-16 card flex justify-around items-center border-t-2 z-40">
        <button data-tab="dashboard" class="mobile-tab flex flex-col items-center justify-center w-full h-full">
            <i data-lucide="user-2" class="w-6 h-6"></i>
            <span class="text-xs">Dashboard</span>
        </button>
        <button data-tab="quests" class="mobile-tab flex flex-col items-center justify-center w-full h-full active">
            <i data-lucide="scroll-text" class="w-6 h-6"></i>
            <span class="text-xs">Quests</span>
        </button>
        <button data-tab="shop" class="mobile-tab flex flex-col items-center justify-center w-full h-full">
            <i data-lucide="store" class="w-6 h-6"></i>
            <span class="text-xs">Shop</span>
        </button>
    </div>

    <!-- Modals & Toasts -->
    <div id="confirmationModal" class="modal fixed inset-0 bg-black/75 items-center justify-center z-50 p-4"></div>
    <div id="editModal" class="modal fixed inset-0 bg-black/75 items-center justify-center z-50 p-4"></div>
    <div id="questLogModal" class="modal fixed inset-0 bg-black/75 items-center justify-center z-50 p-4"></div>
    <div id="settingsModal" class="modal fixed inset-0 bg-black/75 items-center justify-center z-50 p-4"></div>
    <div id="avatarModal" class="modal fixed inset-0 bg-black/75 items-center justify-center z-50 p-4"></div>
    <div id="toast-container" class="fixed bottom-5 right-5 space-y-2 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const TaskQuest = {
                // --- Properties ---
                db: null,
                auth: null,
                userId: null,
                docRef: null,
                unsubscribe: null,
                state: {},
                config: {},
                dom: {},
                statsChart: null,
                categoryChart: null,
                skillRadarChart: null,
                timeOfDayChart: null,
                saveTimeout: null,
                tempSubtasks: [],
                audioContextStarted: false,
                audio: null,

                // --- Initialization ---
                async init() {
                    this.setupConfig();
                    this.state = this.getDefaultState();
                    this.initAudio();
                    this.cacheDOM();
                    this.bindEvents();
                    await this.initFirebase();
                    this.switchMobileTab(this.state.uiSettings.activeMobileTab);
                },
                
                async initFirebase() {
                    try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-task-quest';
                        
                        if (typeof __firebase_config === 'undefined') {
                            console.error("Firebase configuration is missing. App cannot connect to backend.");
                            this.loadStateFromLocalStorage(); 
                            this.render();
                            return;
                        }

                        const firebaseConfig = JSON.parse(__firebase_config);
                        
                        const app = initializeApp(firebaseConfig);
                        this.db = getFirestore(app);
                        this.auth = getAuth(app);

                        // Use custom token if available (in collaborative environment), otherwise sign in anonymously
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(this.auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(this.auth);
                        }
                        
                        this.userId = this.auth.currentUser.uid;
                        this.docRef = doc(this.db, "artifacts", appId, "users", this.userId);
                        
                        this.listenForFirestoreChanges();

                    } catch (error) {
                        console.error("Firebase initialization failed:", error);
                        // Fallback to local storage if Firebase fails
                        this.loadStateFromLocalStorage(); 
                        this.render();
                    }
                },

                initAudio() {
                    this.audio = {
                        startContext: () => {
                            if (this.audioContextStarted || typeof Tone === 'undefined') return;
                            Tone.start();
                            this.audioContextStarted = true;
                            console.log('Audio context started.');
                        },
                        playComplete: () => {
                            if (!this.state.settings.sound || typeof Tone === 'undefined') return;
                            const synth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 } }).toDestination();
                            synth.triggerAttackRelease('E5', '8n');
                        },
                        playCoin: () => {
                            if (!this.state.settings.sound || typeof Tone === 'undefined') return;
                            const synth = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
                            synth.triggerAttackRelease('G5', '16n');
                        },
                        playLevelUp: () => {
                            if (!this.state.settings.sound || typeof Tone === 'undefined') return;
                            const synth = new Tone.PolySynth(Tone.Synth).toDestination();
                            const now = Tone.now();
                            synth.triggerAttackRelease(['C4', 'E4', 'G4', 'C5'], '8n', now);
                        },
                        playAchievement: () => {
                            if (!this.state.settings.sound || typeof Tone === 'undefined') return;
                            const synth = new Tone.FMSynth({ harmonicity: 3.01, modulationIndex: 14, envelope: { attack: 0.01, decay: 0.2, sustain: 0.01, release: 0.5 }, modulationEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.01, release: 0.5 } }).toDestination();
                            const now = Tone.now();
                            synth.triggerAttackRelease('C5', '8n', now);
                            synth.triggerAttackRelease('E5', '8n', now + 0.1);
                            synth.triggerAttackRelease('G5', '8n', now + 0.2);
                        },
                        playAddTask: () => {
                            if (!this.state.settings.sound || typeof Tone === 'undefined') return;
                            const synth = new Tone.MembraneSynth().toDestination();
                            synth.triggerAttackRelease("C2", "8n");
                        },
                    };
                    document.body.addEventListener('click', () => this.audio.startContext(), { once: true });
                },

                setupConfig() {
                    this.config = {
                        xpForLevel: level => Math.floor(100 * Math.pow(1.5, level - 1)),
                        goldForTask: xp => Math.ceil(xp / 8),
                        priorityMultiplier: { low: 1, medium: 1.1, high: 1.25 },
                        classBonuses: {
                            knight: { type: 'gold', categories: ['Fitness', 'Chores'], multiplier: 1.1, description: '+10% Gold from Fitness & Chore quests.' },
                            mage: { type: 'xp', categories: ['Learning', 'Creative'], multiplier: 1.1, description: '+10% XP from Learning & Creative quests.' },
                            archer: { type: 'crit', chance: 0.05, multiplier: 2, description: '5% chance to double quest rewards.' },
                        },
                        achievements: [ { id: 'quests1', name: 'Quest Novice', desc: 'Complete 10 quests.', condition: state => state.player.stats.questsCompleted >= 10 }, { id: 'quests2', name: 'Quest Adept', desc: 'Complete 50 quests.', condition: state => state.player.stats.questsCompleted >= 50 }, { id: 'gold1', name: 'Gold Hoarder', desc: 'Earn 1,000 total gold.', condition: state => state.player.stats.totalGoldEarned >= 1000 }, { id: 'level1', name: 'Level Up!', desc: 'Reach player level 5.', condition: state => state.player.level >= 5 }, { id: 'streak1', name: 'On a Roll', desc: 'Maintain a 3-day streak.', condition: state => state.player.streak >= 3 }, ],
                        heroJourney: [
                            { id: 'hj1', name: 'The First Step', desc: 'Reach Player Level 5.', condition: state => state.player.level >= 5, reward: { type: 'passive_gold_bonus', value: 0.01 }, rewardDesc: "+1% to all Gold gains." },
                            { id: 'hj2', name: 'Master of the Mundane', desc: "Reach Level 10 in the 'Chores' skill.", condition: state => state.skills['Chores'] && state.skills['Chores'].level >= 10, reward: { type: 'passive_daily_xp_bonus', value: 0.1 }, rewardDesc: "Daily quests are worth 10% more XP." },
                            { id: 'hj3', name: "The Dragon's Hoard", desc: 'Earn a total of 2,500 Gold.', condition: state => state.player.stats.totalGoldEarned >= 2500, reward: { type: 'avatar_unlock', value: 'gold_dragon' }, rewardDesc: "Unlock the Gold Dragon avatar." },
                            { id: 'hj4', name: "The Sage's Wisdom", desc: 'Complete 100 quests.', condition: state => state.player.stats.questsCompleted >= 100, reward: { type: 'passive_xp_bonus', value: 0.02 }, rewardDesc: "+2% to all XP gains." },
                            // Expansion starts here
                            { id: 'hj5', name: 'Adept Adventurer', desc: 'Reach Player Level 10.', condition: state => state.player.level >= 10, reward: { type: 'passive_xp_bonus', value: 0.01 }, rewardDesc: "+1% to all XP gains." },
                            { id: 'hj6', name: 'The Resilient', desc: 'Maintain a 7-day streak.', condition: state => state.player.streak >= 7, reward: { type: 'title_unlock', value: 'the Resilient' }, rewardDesc: "Unlock the title: 'the Resilient'." },
                            { id: 'hj7', name: 'Treasure Hunter', desc: 'Earn a total of 5,000 Gold.', condition: state => state.player.stats.totalGoldEarned >= 5000, reward: { type: 'passive_gold_bonus', value: 0.02 }, rewardDesc: "+2% to all Gold gains." },
                            { id: 'hj8', name: 'Skill Virtuoso', desc: "Reach Level 15 in any skill.", condition: state => Object.values(state.skills).some(s => s.level >= 15), reward: { type: 'theme_unlock', value: 'emerald' }, rewardDesc: "Unlock the 'Emerald' theme." },
                            { id: 'hj9', name: 'Quest Conqueror', desc: 'Complete 250 quests.', condition: state => state.player.stats.questsCompleted >= 250, reward: { type: 'passive_xp_bonus', value: 0.02 }, rewardDesc: "+2% to all XP gains." },
                            { id: 'hj10', name: 'Veteran Warrior', desc: 'Reach Player Level 20.', condition: state => state.player.level >= 20, reward: { type: 'avatar_unlock', value: 'warrior' }, rewardDesc: "Unlock the Warrior avatar." },
                            { id: 'hj11', name: 'The Unstoppable', desc: 'Maintain a 30-day streak.', condition: state => state.player.streak >= 30, reward: { type: 'title_unlock', value: 'the Unstoppable' }, rewardDesc: "Unlock the title: 'the Unstoppable'." },
                            { id: 'hj12', name: 'Midas Touch', desc: 'Earn a total of 10,000 Gold.', condition: state => state.player.stats.totalGoldEarned >= 10000, reward: { type: 'theme_unlock', value: 'ruby' }, rewardDesc: "Unlock the 'Ruby' theme." },
                            { id: 'hj13', name: 'Big Spender', desc: 'Spend 5,000 Gold in the shops.', condition: state => state.player.stats.totalGoldSpent >= 5000, reward: { type: 'passive_gold_bonus', value: 0.03 }, rewardDesc: "+3% to all Gold gains." },
                            { id: 'hj14', name: 'Quest Grandmaster', desc: 'Complete 500 quests.', condition: state => state.player.stats.questsCompleted >= 500, reward: { type: 'passive_xp_bonus', value: 0.03 }, rewardDesc: "+3% to all XP gains." },
                            { id: 'hj15', name: 'Archmage', desc: 'Reach Player Level 30.', condition: state => state.player.level >= 30, reward: { type: 'avatar_unlock', value: 'sorcerer' }, rewardDesc: "Unlock the Sorcerer avatar." },
                            { id: 'hj16', name: 'Jack of All Trades', desc: "Reach Level 10 in 4 different skills.", condition: state => Object.values(state.skills).filter(s => s.level >= 10).length >= 4, reward: { type: 'title_unlock', value: 'Jack of All Trades' }, rewardDesc: "Unlock the title: 'Jack of All Trades'." },
                            { id: 'hj17', name: 'Wealthy Baron', desc: 'Earn a total of 25,000 Gold.', condition: state => state.player.stats.totalGoldEarned >= 25000, reward: { type: 'passive_gold_bonus', value: 0.04 }, rewardDesc: "+4% to all Gold gains." },
                            { id: 'hj18', name: 'Bounty Hunter', desc: 'Complete 10 Bounties.', condition: state => Object.keys(state.bounties.completedToday).length >= 10, reward: { type: 'title_unlock', value: 'Bounty Hunter' }, rewardDesc: "Unlock the title: 'Bounty Hunter'." },
                            { id: 'hj19', name: 'Master of Fate', desc: 'Reach Player Level 50.', condition: state => state.player.level >= 50, reward: { type: 'avatar_unlock', value: 'master' }, rewardDesc: "Unlock the Master avatar." },
                            { id: 'hj20', name: 'Living Legend', desc: 'Complete 1,000 quests.', condition: state => state.player.stats.questsCompleted >= 1000, reward: { type: 'passive_xp_bonus', value: 0.05 }, rewardDesc: "+5% to all XP gains." },
                            { id: 'hj21', name: 'Unbroken Will', desc: 'Maintain a 60-day streak.', condition: state => state.player.streak >= 60, reward: { type: 'passive_gold_bonus', value: 0.05 }, rewardDesc: "+5% to all Gold gains." },
                            { id: 'hj22', name: 'Gold Baron', desc: 'Earn a total of 50,000 Gold.', condition: state => state.player.stats.totalGoldEarned >= 50000, reward: { type: 'title_unlock', value: 'Gold Baron' }, rewardDesc: "Unlock the title: 'Gold Baron'." },
                            { id: 'hj23', name: 'True Hero', desc: 'Reach Player Level 75.', condition: state => state.player.level >= 75, reward: { type: 'passive_xp_bonus', value: 0.05 }, rewardDesc: "+5% to all XP gains." },
                            { id: 'hj24', name: 'Polymath', desc: "Reach Level 25 in any skill.", condition: state => Object.values(state.skills).some(s => s.level >= 25), reward: { type: 'passive_gold_bonus', value: 0.05 }, rewardDesc: "+5% to all Gold gains." },
                            { id: 'hj25', name: 'Quest Master', desc: 'Complete 2,000 quests.', condition: state => state.player.stats.questsCompleted >= 2000, reward: { type: 'title_unlock', value: 'Quest Master' }, rewardDesc: "Unlock the title: 'Quest Master'." },
                            { id: 'hj26', name: 'The Legend', desc: 'Reach Player Level 100.', condition: state => state.player.level >= 100, reward: { type: 'avatar_unlock', value: 'legend' }, rewardDesc: "Unlock the Legend avatar & title." },
                        ],
                        bountyPool: [
                            { id: 'b1', name: 'Fitness Fanatic', desc: "Complete 3 'Fitness' quests today.", reward: { xp: 100, gold: 50 }, condition: (state) => state.completedTasks.filter(t => t.category === 'Fitness' && new Date(t.completedAt).toDateString() === new Date().toDateString()).length >= 3 },
                            { id: 'b2', name: 'Learning Spree', desc: "Complete 3 'Learning' quests today.", reward: { xp: 100, gold: 50 }, condition: (state) => state.completedTasks.filter(t => t.category === 'Learning' && new Date(t.completedAt).toDateString() === new Date().toDateString()).length >= 3 },
                            { id: 'b3', name: 'Productive Power Hour', desc: 'Complete 2 quests in one hour.', reward: { xp: 75, gold: 25 }, condition: (state) => {
                                const recent = state.completedTasks.filter(t => (Date.now() - new Date(t.completedAt).getTime()) < 3600000);
                                return recent.length >= 2;
                            }},
                            { id: 'b4', name: 'High Roller', desc: 'Complete a quest worth over 200 XP.', reward: { xp: 50, gold: 50 }, condition: (state) => state.completedTasks.some(t => t.xp >= 200 && new Date(t.completedAt).toDateString() === new Date().toDateString()) },
                            { id: 'b5', name: 'Streak Keeper', desc: 'Maintain your daily streak.', reward: { xp: 50, gold: 20 }, condition: (state) => state.player.streak > 1 && state.player.lastCompletedDate === new Date().toDateString() }
                        ],
                        blackMarketItems: [
                            { id: 'item1', name: 'Potion of Swift Learning', desc: "+25% XP from 'Learning' quests for 24 hours.", cost: 250, duration: 24, effect: { type: 'xp_boost', category: 'Learning', value: 0.25 }, icon: 'flask-conical' },
                            { id: 'item2', name: 'Elixir of Strength', desc: "+25% XP from 'Fitness' quests for 24 hours.", cost: 250, duration: 24, effect: { type: 'xp_boost', category: 'Fitness', value: 0.25 }, icon: 'flask-conical' },
                            { id: 'item4', name: 'Amulet of Prosperity', desc: 'Permanently gain +1 Gold from every quest.', cost: 1500, duration: Infinity, effect: { type: 'gold_flat_bonus', value: 1 }, icon: 'gem' },
                        ],
                        avatars: {
                            knight: `data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9IiMxRjI5MzkiLz48cmVjdCB4PSI4IiB5PSIyIiB3aWR0aD0iOCIgaGVpZ2h0PSIyIiBmaWxsPSIjQzhDNUM2Ii8+PHJlY3QgeD0iOCIgeT0iNCIgd2lkdGg9IjgiIGhlaWdodD0iNiIgZmlsbD0iIzUzNUU1QiIvPjxyZWN0IHg9IjEwIiB5PSI2IiB3aWR0aD0iNCIgaGVpZ2h0PSIyIiBmaWxsPSIjM0Q0NTUwIi8+PHJlY3QgeD0iNiIgeT0iMTAiIHdpZHRoPSIxMiIgaGVpZ2h0PSI0IiBmaWxsPSIjNTM1RUY1Ii8+PHJlY3QgeD0iNiIgeT0iMTQiIHdpZHRoPSIzIiBoZWlnaHQ9IjYiIGZpbGw9IiM1MzVFRjUiLz48cmVjdCB4PSIxNSIgeT0iMTQiIHdpZHRoPSIzIiBoZWlnaHQ9IjYiIGZpbGw9IiM1MzVFRjUiLz48cmVjdCB4PSI5IiB5PSIxNCIgd2lkdGg9IjYiIGhlaWdodD0iNiIgZmlsbD0iIzQ2NTE1OSIvPjxyZWN0IHg9IjYiIHk9IjIwIiB3aWR0aD0iMyIgaGVpZ2h0PSIyIiBmaWxsPSIjM0Q0NTUwIi8+PHJlY3QgeD0iMTUiIHk9IjIwIiB3aWR0aD0iMyIgaGVpZ2h0PSIyIiBmaWxsPSIjM0Q0NTUwIi8+PC9zdmc+`,
                            mage: `data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9IiMxRjI5MzkiLz48cGF0aCBkPSJNNiAyTDEyIDZMMTggMkwxMiAxMFYyWiIgZmlsbD0iIzRGNzVFOSIvPjxyZWN0IHg9IjgiIHk9IjEwIiB3aWR0aD0iOCIgaGVpZ2h0PSIyIiBmaWxsPSIjRkZENUI4Ii8+PHJlY3QgeD0iNiIgeT0iMTIiIHdpZHRoPSIxMiIgaGVpZ2h0PSI4IiBmaWxsPSIjNEY3NUU5Ii8+PHJlY3QgeD0iOCIgeT0iMjAiIHdpZHRoPSI4IiBoZWlnaHQ9IjIiIGZpbGw9IiM0QzUwMzkiLz48L3N2Zz4=`,
                            archer: `data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9IiMxRjI5MzkiLz48cmVjdCB4PSI4IiB5PSIyIiB3aWR0aD0iOCIgaGVpZ2h0PSIyIiBmaWxsPSIjRkY1RDc4Ii8+PHJlY3QgeD0iOCIgeT0iNCIgd2lkdGg9IjgiIGhlaWdodD0iNiIgZmlsbD0iIzJFN0Q0QyIvPjxyZWN0IHg9IjEwIiB5PSI2IiB3aWR0aD0iNCIgaGVpZ2h0PSIyIiBmaWxsPSIjMkM2QTQwIi8+PHJlY3QgeD0iNiIgeT0iMTAiIHdpZHRoPSIxMiIgaGVpZ2h0PSI4IiBmaWxsPSIjMkU3RDRDIi8+PHJlY3QgeD0iNiIgeT0iMTgiIHdpZHRoPSIzIiBoZWlnaHQ9IjQiIGZpbGw9IiM2QjQyMkYiLz48cmVjdCB4PSIxNSIgeT0iMTgiIHdpZHRoPSIzIiBoZWlnaHQ9IjQiIGZpbGw9IiM2QjQyMkYiLz48cmVjdCB4PSI5IiB5PSIxOCIgd2lkdGg9IjYiIGhlaWdodD0iNCIgZmlsbD0iIzVCMzgzMSIvPjwvc3ZnPg==`,
                            gold_dragon: `data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9IiMxRjI5MzkiLz48cGF0aCBkPSJNMyAxMkw4IDdMMTMgMTJMOCAxN1oiIGZpbGw9IiNGQUMxNUMiLz48cGF0aCBkPSJNMTMgMTJMMTggN0wyMyAxMkwxOCAxN1oiIGZpbGw9IiNGOUExMkIiLz48cmVjdCB4PSI4IiB5PSIyIiB3aWR0aD0iOCIgaGVpZ2h0PSI1IiBmaWxsPSIjRkFDMTVDIi8+PC9zdmc+`,
                            warrior: `data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9IiMxRjI5MzkiLz48cmVjdCB4PSI5IiB5PSIyIiB3aWR0aD0iNiIgaGVpZ2h0PSI0IiBmaWxsPSIjRTUzOTM1Ii8+PHJlY3QgeD0iNyIgeT0iNiIgd2lkdGg9IjEwIiBoZWlnaHQ9IjQiIGZpbGw9IiM3ODk2QUIiLz48cmVjdCB4PSI3IiB5PSIxMCIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSIjNDU1ODE1Ii8+PHJlY3QgeD0iNCIgeT0iMTIiIHdpZHRoPSIzIiBoZWlnaHQ9IjYiIGZpbGw9IiM3ODk2QUIiLz48cmVjdCB4PSIxNyIgeT0iMTIiIHdpZHRoPSIzIiBoZWlnaHQ9IjYiIGZpbGw9IiM3ODk2QUIiLz48L3N2Zz4=`,
                            sorcerer: `data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9IiMxRjI5MzkiLz48cGF0aCBkPSJNMTIgMkw2IDdMMTIgMTJMNyA3TDEyIDE3TDcgMTJMMTIgMkwxNyA3TDEyIDEyTDE3IDE3TDEyIDEyTDE4IDdaIiBmaWxsPSIjOEI1Q0Y2Ii8+PHJlY3QgeD0iNyIgeT0iMTgiIHdpZHRoPSIxMCIgaGVpZ2h0PSI0IiBmaWxsPSIjOEI1Q0Y2Ii8+PC9zdmc+`,
                            master: `data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9IiMxRjI5MzkiLz48cmVjdCB4PSI4IiB5PSIyIiB3aWR0aD0iOCIgaGVpZ2h0PSIyIiBmaWxsPSIjRkZGRkZGIi8+PHJlY3QgeD0iOCIgeT0iNCIgd2lkdGg9IjgiIGhlaWdodD0iNiIgZmlsbD0iI0Y4Q0M0RiIvPjxyZWN0IHg9IjEwIiB5PSI2IiB3aWR0aD0iNCIgaGVpZ2h0PSIyIiBmaWxsPSIjRDhBRjdGIi8+PHJlY3QgeD0iNiIgeT0iMTAiIHdpZHRoPSIxMiIgaGVpZ2h0PSI4IiBmaWxsPSIjRkZGRkZGIi8+PHJlY3QgeD0iNiIgeT0iMTgiIHdpZHRoPSIxMiIgaGVpZ2h0PSI0IiBmaWxsPSIjRDhBRjdGIi8+PC9zdmc+`,
                            legend: `data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9IiMxRjI5MzkiLz48cGF0aCBkPSJNMTEgMkw4IDhIMTRMMTEgMloiIGZpbGw9IiNGQUMxNUMiLz48cmVjdCB4PSI4IiB5PSI4IiB3aWR0aD0iNiIgaGVpZ2h0PSIxNCIgZmlsbD0iI0Y5QTExQiIvPjxyZWN0IHg9IjMiIHk9IjEwIiB3aWR0aD0iNSIgaGVpZ2h0PSI4IiBmaWxsPSIjRkFDMTVDIi8+PHJlY3QgeD0iMTYiIHk9IjEwIiB3aWR0aD0iNSIgaGVpZ2h0PSI4IiBmaWxsPSIjRkFDMTVDIi8+PC9zdmc+`
                        },
                    };
                },

                getDefaultState() {
                    return JSON.parse(JSON.stringify({ // Deep copy to prevent mutation
                        character: { name: 'Hero', avatar: 'knight', class: 'knight', title: null },
                        player: { 
                            level: 1, xp: 0, gold: 0, streak: 0, lastCompletedDate: null, activeBuffs: [],
                            stats: { 
                                questsCompleted: 0, totalGoldEarned: 0, totalXpGained: 0, 
                                questsCompletedToday: 0, goldEarnedToday: 0, totalGoldSpent: 0
                            } 
                        },
                        tasks: [], shop: [], skills: {}, unlockedAchievements: {},
                        completedTasks: [], unlockedJourneyChapters: {},
                        bounties: { active: [], completedToday: {}, lastDate: null },
                        unlockedThemes: ['dark', 'light', 'forest', 'sapphire', 'amethyst'],
                        editing: { type: null, id: null },
                        settings: { theme: 'dark', sound: true },
                        uiSettings: {
                            sortBy: 'id-desc',
                            filterCategory: 'all',
                            activeMobileTab: 'quests'
                        }
                    }));
                },

                cacheDOM() {
                    this.dom = {
                        playerXpBar: document.getElementById('player-xp-bar'), playerXpText: document.getElementById('player-xp-text'), playerGold: document.getElementById('player-gold'), playerStreak: document.getElementById('player-streak'), addTaskForm: document.getElementById('add-task-form'), addRewardForm: document.getElementById('add-reward-form'), xpSlider: document.getElementById('task-xp'), xpSliderValue: document.getElementById('task-xp-value'), skillSuggestions: document.getElementById('skill-suggestions'), taskList: document.getElementById('task-list'), shopList: document.getElementById('shop-list'), skillsList: document.getElementById('skills-list'), heroJourneyList: document.getElementById('hero-journey-list'), playerProfileStats: document.getElementById('player-profile-stats'), achievementsList: document.getElementById('achievements-list'), toastContainer: document.getElementById('toast-container'), confirmationModal: document.getElementById('confirmationModal'), editModal: document.getElementById('editModal'), questLogModal: document.getElementById('questLogModal'), questLogBtn: document.getElementById('quest-log-btn'), statsChartCanvas: document.getElementById('stats-chart'), settingsBtn: document.getElementById('settings-btn'), settingsModal: document.getElementById('settingsModal'), avatarDisplay: document.getElementById('avatar-display'), characterNameInput: document.getElementById('character-name'), characterClass: document.getElementById('character-class'), characterTitle: document.getElementById('character-title'), playerLevel: document.getElementById('player-level'),
                        playerCard: document.getElementById('player-card'),
                        activeBuffsContainer: document.getElementById('active-buffs-container'),
                        blackMarketSection: document.getElementById('black-market-section'),
                        bountyBoardCard: document.getElementById('bounty-board-card'),
                        weeklyFocusText: document.getElementById('weekly-focus-text'),
                        addSubtaskBtn: document.getElementById('add-subtask-btn'), subtaskNameInput: document.getElementById('subtask-name'), subtasksContainer: document.getElementById('subtasks-container'),
                        
                        profileTabs: document.querySelectorAll('.profile-tab'),
                        profileTabContents: {
                            weekly: document.getElementById('profile-tab-content-weekly'),
                            category: document.getElementById('profile-tab-content-category'),
                            insights: document.getElementById('profile-tab-content-insights'),
                        },
                        categoryDonutChartCanvas: document.getElementById('category-donut-chart'),
                        skillRadarChartCanvas: document.getElementById('skill-radar-chart'),
                        timeOfDayChartCanvas: document.getElementById('time-of-day-chart'),
                        productivityHeatmapContainer: document.getElementById('productivity-heatmap'),

                        toggleAdvancedBtn: document.getElementById('toggle-advanced-btn'), advancedOptionsContainer: document.getElementById('advanced-options'),
                        filterCategory: document.getElementById('filter-category'), sortTasks: document.getElementById('sort-tasks'),
                        mobileTabBar: document.getElementById('mobile-tab-bar'),
                        mobilePanels: {
                            dashboard: document.getElementById('mobile-panel-dashboard'),
                            quests: document.getElementById('mobile-panel-quests'),
                            shop: document.getElementById('mobile-panel-shop'),
                        },
                        taskRecurrence: document.getElementById('task-recurrence'),
                        recurrenceOptions: document.getElementById('recurrence-options'),
                    };
                },

                bindEvents() {
                    // Forms
                    this.dom.addTaskForm.addEventListener('submit', e => this.handleAddTask(e));
                    this.dom.addRewardForm.addEventListener('submit', e => this.handleAddReward(e));

                    // Main list clicks (delegated)
                    this.dom.taskList.addEventListener('click', e => this.handleGenericListClick(e));
                    this.dom.skillsList.addEventListener('click', e => {
                        const focusButton = e.target.closest('button[data-action="set-focus"]');
                        if (focusButton) {
                            this.handleSetFocus(focusButton.dataset.skill);
                        }
                    });
                    
                    this.dom.shopList.addEventListener('click', e => this.handleGenericListClick(e));
                    this.dom.blackMarketSection.addEventListener('click', e => {
                        const buyButton = e.target.closest('button[data-action="buy-black-market-item"]');
                        if(buyButton) this.buyBlackMarketItem(buyButton.dataset.id);
                    });

                    // Global clicks (modals, etc. - delegated)
                    document.body.addEventListener('click', e => {
                        if (e.target.closest('#settingsCloseBtn')) this.hideModal('settingsModal');
                        if (e.target.closest('#avatarCloseBtn')) this.hideModal('avatarModal');
                        if (e.target.closest('#questLogCloseBtn')) this.hideModal('questLogModal');
                        if (e.target.closest('#editCancelBtn')) this.hideModal('editModal');
                        if (e.target.closest('#modalCancelBtn')) this.hideModal('confirmationModal');

                        const avatarButton = e.target.closest('button[data-avatar]');
                        if (avatarButton) this.handleAvatarSelect(avatarButton.dataset.avatar);
                    });
                     document.body.addEventListener('submit', e => {
                        if (e.target.id === 'edit-form') this.handleEditSubmit(e);
                    });


                    // Inputs & Selects
                    this.dom.xpSlider.addEventListener('input', () => this.dom.xpSliderValue.textContent = `${this.dom.xpSlider.value} XP`);
                    this.dom.characterNameInput.addEventListener('change', e => this.handleNameChange(e));
                    this.dom.filterCategory.addEventListener('change', e => this.handleFilterChange(e));
                    this.dom.sortTasks.addEventListener('change', e => this.handleSortChange(e));
                    this.dom.taskRecurrence.addEventListener('change', e => this.renderRecurrenceOptions(e.target.value));

                    // Buttons
                    this.dom.settingsBtn.addEventListener('click', () => this.showModal('settingsModal'));
                    this.dom.questLogBtn.addEventListener('click', () => this.showModal('questLogModal'));
                    this.dom.avatarDisplay.addEventListener('click', () => this.showModal('avatarModal'));
                    this.dom.addSubtaskBtn.addEventListener('click', () => this.handleAddSubtask());
                    this.dom.subtasksContainer.addEventListener('click', e => this.handleDeleteTempSubtask(e));
                    
                    this.dom.profileTabs.forEach(tab => {
                        tab.addEventListener('click', () => this.switchProfileTab(tab.dataset.tab));
                    });

                    this.dom.toggleAdvancedBtn.addEventListener('click', () => this.toggleAdvancedOptions());
                    
                    // Mobile Nav
                    this.dom.mobileTabBar.addEventListener('click', e => {
                        const tabButton = e.target.closest('.mobile-tab');
                        if (tabButton) this.switchMobileTab(tabButton.dataset.tab);
                    });
                },
                
                // --- State Management & Data ---
                listenForFirestoreChanges() {
                    if (this.unsubscribe) this.unsubscribe();
                    this.unsubscribe = onSnapshot(this.docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            this.updateLocalState(docSnap.data());
                            this.generateBounties();
                        } else {
                            console.log("No user data found, creating new document.");
                            this.state = this.getDefaultState();
                            this.generateBounties();
                            this.saveStateToFirestore(); 
                        }
                        this.applyTheme();
                        this.render();
                    }, (error) => {
                        console.error("Firestore listener failed:", error);
                        this.loadStateFromLocalStorage();
                        this.render();
                    });
                },

                updateLocalState(firestoreData) {
                    const defaultState = this.getDefaultState();
                    // Deep merge to ensure all properties from defaultState are present
                    this.state = {
                        ...defaultState,
                        ...firestoreData,
                        character: { ...defaultState.character, ...(firestoreData.character || {}) },
                        player: {
                            ...defaultState.player,
                            ...(firestoreData.player || {}),
                            activeBuffs: firestoreData.player && firestoreData.player.activeBuffs ? firestoreData.player.activeBuffs : [],
                            stats: { ...defaultState.player.stats, ...(firestoreData.player ? (firestoreData.player.stats || {}) : {}) }
                        },
                        bounties: { ...defaultState.bounties, ...(firestoreData.bounties || {}) },
                        settings: { ...defaultState.settings, ...(firestoreData.settings || {}) },
                        uiSettings: { ...defaultState.uiSettings, ...(firestoreData.uiSettings || {}) },
                        unlockedJourneyChapters: { ...defaultState.unlockedJourneyChapters, ...(firestoreData.unlockedJourneyChapters || {}) },
                        unlockedThemes: firestoreData.unlockedThemes || defaultState.unlockedThemes,
                    };
                },

                loadStateFromLocalStorage() { 
                    const savedState = localStorage.getItem('taskQuestState'); 
                    if (savedState) { this.state = JSON.parse(savedState); }
                },
                
                async saveStateToFirestore() {
                    if (!this.docRef) {
                        localStorage.setItem('taskQuestState', JSON.stringify(this.state));
                        return;
                    }
                    try {
                        // Deep copy state to avoid serializing functions or other non-plain objects
                        const stateToSave = JSON.parse(JSON.stringify(this.state));
                        await setDoc(this.docRef, stateToSave);
                    } catch (error) {
                        console.error("Error saving state to Firestore:", error);
                    }
                },

                saveStateDebounced() {
                    if (this.saveTimeout) clearTimeout(this.saveTimeout);
                    this.saveTimeout = setTimeout(() => this.saveStateToFirestore(), 1500);
                },

                getPassiveBonuses() {
                    let xpBonus = 0;
                    let goldBonus = 0;
                    Object.keys(this.state.unlockedJourneyChapters).forEach(chapterId => {
                        const chapter = this.config.heroJourney.find(c => c.id === chapterId);
                        if (chapter && chapter.reward) {
                            if (chapter.reward.type === 'passive_xp_bonus') {
                                xpBonus += chapter.reward.value;
                            }
                            if (chapter.reward.type === 'passive_gold_bonus') {
                                goldBonus += chapter.reward.value;
                            }
                        }
                    });
                    return { xpBonus, goldBonus };
                },

                // --- Core Game Logic ---
                completeTask(taskId, element) {
                    const taskIndex = this.state.tasks.findIndex(t => t.id === taskId);
                    if (taskIndex === -1) return;
                    
                    const task = { ...this.state.tasks[taskIndex] };

                    // --- Reward Calculation ---
                    const { finalXp, goldGained, rewardsLogHtml } = this.calculateRewards(task);

                    // Animate base rewards
                    this.animateRewardGain(element, `+${Math.round(finalXp)} XP`, 'xp');
                    setTimeout(() => {
                        this.animateRewardGain(element, `+${Math.round(goldGained)} G`, 'gold');
                        this.audio.playCoin();
                    }, 200);
                    
                    
                    // --- Animation & State Update Logic ---
                    const isRecurring = task.recurrence && task.recurrence.type !== 'none';
                    if (!isRecurring) {
                        element.classList.add('anim-fade-out');
                    } else {
                        element.classList.add('quest-complete-flash');
                        element.addEventListener('animationend', () => {
                            element.classList.remove('quest-complete-flash');
                        }, { once: true });
                    }

                    const onComplete = () => {
                        this.applyRewards(task, finalXp, goldGained, rewardsLogHtml);
                        const allRewardsHtml = this.processPostCompletion(task, finalXp, goldGained, rewardsLogHtml);
                        this.showToast(...allRewardsHtml);
                        this.render();
                    };

                    if (!isRecurring) {
                        element.addEventListener('animationend', onComplete, { once: true });
                    } else {
                        onComplete(); // No animation for removal, but flash still happens
                    }
                },
                
                calculateRewards(task) {
                    let finalXp = task.xp;
                    let goldGained = this.config.goldForTask(finalXp);
                    let rewardsLogHtml = '';

                    // --- Check and Apply Active Buffs ---
                    this.checkActiveBuffs(); // Remove expired buffs
                    this.state.player.activeBuffs.forEach(buff => {
                        const item = this.config.blackMarketItems.find(i => i.id === buff.id);
                        if (!item) return;

                        if (item.effect.type === 'xp_boost' && item.effect.category === task.category) {
                            const bonusXp = Math.round(finalXp * item.effect.value);
                            finalXp += bonusXp;
                            rewardsLogHtml += `<p><span class="text-green-400 font-semibold">+${bonusXp} XP (${item.name})</span></p>`;
                        }
                        if (item.effect.type === 'gold_boost') {
                            const bonusGold = Math.round(goldGained * item.effect.value);
                            goldGained += bonusGold;
                            rewardsLogHtml += `<p><span class="gold-text font-semibold">+${bonusGold} G (${item.name})</span></p>`;
                        }
                        if (item.effect.type === 'gold_flat_bonus') {
                            goldGained += item.effect.value;
                        }
                    });

                    const { class: playerClass } = this.state.character;
                    const classBonus = this.config.classBonuses[playerClass];

                    if (classBonus.type === 'xp' && classBonus.categories.includes(task.category)) {
                        const bonusXp = Math.round(finalXp * (classBonus.multiplier - 1));
                        finalXp += bonusXp;
                        rewardsLogHtml += `<p><span class="text-purple-400 font-semibold">+${bonusXp} XP (Mage Bonus!)</span></p>`;
                    }
                    if (classBonus.type === 'gold' && classBonus.categories.includes(task.category)) {
                        const bonusGold = Math.round(goldGained * (classBonus.multiplier - 1));
                        goldGained += bonusGold;
                        rewardsLogHtml += `<p><span class="gold-text font-semibold">+${bonusGold} G (Knight Bonus!)</span></p>`;
                    }
                    if (classBonus.type === 'crit' && Math.random() < classBonus.chance) {
                        finalXp *= classBonus.multiplier;
                        goldGained *= classBonus.multiplier;
                        rewardsLogHtml += `<p><span class="text-red-400 font-bold">CRITICAL SUCCESS! Rewards Doubled! (Archer)</span></p>`;
                    }

                    // --- Apply Hero's Journey Bonuses ---
                    const passiveBonuses = this.getPassiveBonuses();
                    if (passiveBonuses.xpBonus > 0) finalXp *= (1 + passiveBonuses.xpBonus);
                    if (passiveBonuses.goldBonus > 0) goldGained *= (1 + passiveBonuses.goldBonus);


                    finalXp = Math.round(finalXp * this.config.priorityMultiplier[task.priority || 'medium']);

                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    if (task.dueDate) {
                        const dueDate = new Date(task.dueDate + 'T00:00:00');
                        if (today <= dueDate) {
                            const bonusXp = Math.round(task.xp * 0.1);
                            finalXp += bonusXp;
                            rewardsLogHtml += `<p><span class="text-green-400 font-semibold">+${bonusXp} XP (On-time bonus!)</span></p>`;
                        }
                    }

                    return { finalXp, goldGained, rewardsLogHtml };
                },

                applyRewards(task, finalXp, goldGained, rewardsLogHtml) {
                    const isRecurring = task.recurrence && task.recurrence.type !== 'none';
                    if (isRecurring) {
                        const taskInState = this.state.tasks.find(t => t.id === task.id);
                        if (taskInState) taskInState.lastCompleted = new Date().toISOString().split('T')[0];
                    } else {
                        this.state.tasks = this.state.tasks.filter(t => t.id !== task.id);
                    }

                    this.state.completedTasks.unshift({ ...task, completedAt: new Date().toISOString(), finalXp, goldGained, rewardsLogHtml });
                    this.ensureSkillExists(task.category);

                    this.state.player.xp += finalXp;
                    this.state.player.gold += goldGained;
                    this.state.skills[task.category].xp += finalXp;

                    const stats = this.state.player.stats;
                    stats.questsCompleted++;
                    stats.totalGoldEarned += goldGained;
                    stats.totalXpGained += finalXp;
                    stats.questsCompletedToday++;
                    stats.goldEarnedToday += goldGained;
                },

                processPostCompletion(task, finalXp, goldGained, rewardsLogHtml) {
                    const streakResult = this.updateStreak();
                    const playerLevelResult = this.checkPlayerLevelUp();
                    const skillLevelResult = this.checkSkillLevelUp(task.category);

                    let fullRewardsHtml = rewardsLogHtml.replace(/<p>|<\/p>/g, '');
                    fullRewardsHtml += `<span class="text-accent-primary font-semibold">+${Math.round(finalXp)} XP</span> <span class="gold-text font-semibold">+${Math.round(goldGained)} G</span>`;
                    if (streakResult && streakResult.bonusXP > 0) {
                        fullRewardsHtml += ` <span class="streak-text font-semibold"> Streak ${streakResult.newStreak} (+${Math.round(streakResult.bonusXP)} XP, +${Math.round(streakResult.bonusGold)} G)</span>`;
                    }

                    let toastTitle = 'Quest Complete!';
                    let toastType = 'success';
                    this.audio.playComplete();

                    if (playerLevelResult) {
                        toastTitle = `LEVEL UP! You are now Level ${playerLevelResult.newLevel}!`;
                        toastType = 'levelup';
                    } else if (skillLevelResult) {
                        toastTitle = `${skillLevelResult.category} Skill Up! (Lvl ${skillLevelResult.newLevel})`;
                        toastType = 'levelup';
                    }

                    this.checkAchievements();
                    this.checkHeroJourney();
                    this.checkBounties();

                    return [toastTitle, fullRewardsHtml, toastType];
                },

                checkPlayerLevelUp() {
                    let requiredXp = this.config.xpForLevel(this.state.player.level);
                    let leveledUp = false;
                    while (this.state.player.xp >= requiredXp) {
                        leveledUp = true;
                        this.state.player.level++;
                        this.state.player.xp -= requiredXp;
                        requiredXp = this.config.xpForLevel(this.state.player.level);
                    }
                    if (leveledUp) {
                        this.dom.avatarDisplay.classList.add("level-up-animation");
                        this.dom.playerCard.classList.add("card-flash");
                        this.audio.playLevelUp();
                        setTimeout(() => {
                            this.dom.avatarDisplay.classList.remove("level-up-animation");
                            this.dom.playerCard.classList.remove("card-flash");
                        }, 1500);
                        return { newLevel: this.state.player.level };
                    }
                    return null;
                },

                checkSkillLevelUp(category) {
                    const skill = this.state.skills[category];
                    if (!skill) return null;
                    let requiredXp = this.config.xpForLevel(skill.level);
                    let leveledUp = false;
                    while (skill.xp >= requiredXp) {
                        leveledUp = true;
                        skill.level++;
                        skill.xp -= requiredXp;
                        requiredXp = this.config.xpForLevel(skill.level);
                    }
                    if (leveledUp) {
                        return { category: category, newLevel: skill.level };
                    }
                    return null;
                },

                // --- Event Handlers ---
                handleAddTask(e) { 
                    e.preventDefault(); 
                    const form = this.dom.addTaskForm; 
                    const name = form.querySelector('#task-name').value.trim(); 
                    const category = form.querySelector('#task-category').value.trim(); 
                    const priority = form.querySelector('#task-priority').value; 
                    const dueDate = form.querySelector('#task-due-date').value; 
                    const xp = parseInt(this.dom.xpSlider.value); 
                    if (!name || !category) return; 

                    const recurrenceType = this.dom.taskRecurrence.value;
                    let recurrence = null;
                    if (recurrenceType !== 'none') {
                        recurrence = { type: recurrenceType };
                        if (recurrenceType === 'weekly') {
                            recurrence.days = Array.from(document.querySelectorAll('[name="recurrence-weekly-day"]:checked')).map(el => parseInt(el.value));
                        } else if (recurrenceType === 'monthly') {
                            recurrence.day = parseInt(document.getElementById('recurrence-monthly-day').value);
                        }
                    }

                    const newTask = { id: Date.now(), name, category, xp, priority, dueDate: dueDate || null, subtasks: [...this.tempSubtasks], isNew: true, recurrence, lastCompleted: null }; 
                    
                    this.state.tasks.push(newTask); 
                    this.ensureSkillExists(category); 
                    this.showToast('Quest Added', `<span class="text-accent-primary font-semibold">+${xp} XP</span>`, 'success'); 
                    this.audio.playAddTask(); 
                    this.tempSubtasks = []; 
                    this.renderTempSubtasks(); 
                    this.render(); 
                    form.reset(); 
                    this.renderRecurrenceOptions('none');
                    this.dom.xpSliderValue.textContent = '50 XP'; 
                    setTimeout(() => { newTask.isNew = false; }, 500); 
                },
                
                handleGenericListClick(e) {
                    const button = e.target.closest('button[data-action]');
                    const checkbox = e.target.closest('input[type="checkbox"][data-action]');

                    if (button) {
                        const action = button.dataset.action;
                        const id = button.dataset.id; 

                        switch(action) {
                            case 'complete-task': {
                                const taskEl = button.closest('[data-task-id]');
                                this.completeTask(Number(id), taskEl);
                                break;
                            }
                            case 'delete-task': {
                                const task = this.state.tasks.find(t => t.id === Number(id));
                                if (task) this.showModal('confirmationModal', 'Delete Quest?', `Are you sure you want to delete "${task.name}"?`, () => this.deleteTask(Number(id)));
                                break;
                            }
                            case 'edit-task':
                                this.showEditModal('task', Number(id));
                                break;
                            case 'buy-reward':
                                this.buyReward(Number(id));
                                break;
                            case 'delete-reward': {
                                const reward = this.state.shop.find(r => r.id === Number(id));
                                if (reward) this.showModal('confirmationModal', 'Delete Reward?', `Are you sure you want to delete "${reward.name}"?`, () => this.deleteReward(Number(id)));
                                break;
                            }
                            case 'edit-reward':
                                this.showEditModal('reward', Number(id));
                                break;
                        }
                    }

                    if (checkbox && checkbox.dataset.action === 'toggle-subtask') {
                        const taskId = Number(checkbox.dataset.taskId);
                        const subtaskIndex = Number(checkbox.dataset.subtaskIndex);
                        this.toggleSubtask(taskId, subtaskIndex);
                    }
                },

                handleSetFocus(skillName) {
                    const currentFocus = this.state.uiSettings.weeklyFocusSkill;
                    this.state.uiSettings.weeklyFocusSkill = currentFocus === skillName ? null : skillName;
                    this.render();
                },

                handleEditSubmit(e) {
                    e.preventDefault();
                    const { type, id } = this.state.editing;
                    if (type === 'task') {
                        const task = this.state.tasks.find(t => t.id === id);
                        if (task) {
                            task.name = document.getElementById('edit-name').value;
                            task.category = document.getElementById('edit-category').value;
                            task.xp = parseInt(document.getElementById('edit-xp').value);
                        }
                    } else if (type === 'reward') {
                        const reward = this.state.shop.find(r => r.id === id);
                        if (reward) {
                            reward.name = document.getElementById('edit-name').value;
                            reward.cost = parseInt(document.getElementById('edit-cost').value);
                        }
                    }
                    this.render();
                    this.hideModal('editModal');
                },
                
                // --- Rendering ---
                async render() {
                    this.renderPlayerStats();
                    this.renderTasks();
                    this.renderHeroJourney();
                    this.renderSkills();
                    this.renderShop();
                    this.renderPlayerProfile();
                    this.renderBountyBoard();
                    this.renderStatsChart();
                    this.renderCategoryDonutChart();
                    this.renderSkillRadarChart();
                    this.renderTimeOfDayChart();
                    this.renderProductivityHeatmap();
                    this.renderCharacter();
                    this.renderActiveBuffs();
                    lucide.createIcons();
                    this.saveStateDebounced();
                },

                renderPlayerStats() {
                    const { level, xp, gold, streak } = this.state.player;
                    const requiredXp = this.config.xpForLevel(level);
                    this.dom.playerLevel.textContent = level;
                    this.dom.playerXpText.textContent = `${Math.round(xp)} / ${requiredXp}`;
                    this.dom.playerXpBar.style.width = `${(xp / requiredXp) * 100}%`;
                    this.dom.playerGold.textContent = `${Math.round(gold)} G`;
                    this.dom.playerStreak.textContent = `${streak}`;
                },
                
                renderTasks() { 
                    this.renderFilterOptions();
                    
                    let tasksToDisplay = [...this.state.tasks].filter(task => this.isQuestActiveToday(task));

                    const { filterCategory, sortBy } = this.state.uiSettings;

                    if (filterCategory !== 'all') {
                        tasksToDisplay = tasksToDisplay.filter(task => task.category === filterCategory);
                    }

                    const priorityMap = { high: 3, medium: 2, low: 1 };
                    tasksToDisplay.sort((a, b) => {
                        switch (sortBy) {
                            case 'id-asc': return a.id - b.id;
                            case 'priority-desc': return (priorityMap[b.priority] || 0) - (priorityMap[a.priority] || 0);
                            case 'priority-asc': return (priorityMap[a.priority] || 0) - (priorityMap[b.priority] || 0);
                            case 'due-date-asc':
                                if (!a.dueDate) return 1;
                                if (!b.dueDate) return -1;
                                return new Date(a.dueDate) - new Date(b.dueDate);
                            case 'xp-desc': return b.xp - a.xp;
                            default: return b.id - a.id; // id-desc
                        }
                    });

                    this.renderQuestList(this.dom.taskList, tasksToDisplay); 
                },

                renderQuestList(container, list) {
                    if (list.length === 0) {
                        const emptyState = `<div class="empty-state-container text-sm text-gray-400">
                            <i data-lucide="scroll" class="w-12 h-12 mb-2"></i>
                            <h3 class="font-semibold mt-2">No Quests Here</h3>
                            <p class="mt-1">Add a new quest to begin your adventure.</p>
                        </div>`;
                        container.innerHTML = emptyState;
                        return;
                    }

                    container.innerHTML = list.map(task => { 
                        const isRecurring = !!task.recurrence && task.recurrence.type !== 'none';
                        const isCompletedToday = (isRecurring && task.lastCompleted === new Date().toISOString().split('T')[0]);
                        
                        const subtasksHtml = (task.subtasks && task.subtasks.length > 0) ? `<div class="mt-2 space-y-1 pl-4">${task.subtasks.map((sub, i) => `
                            <div class="flex items-center text-sm">
                                <input type="checkbox" id="subtask-${task.id}-${i}" data-action="toggle-subtask" data-task-id="${task.id}" data-subtask-index="${i}" ${sub.completed ? 'checked' : ''} class="mr-2 h-4 w-4 rounded">
                                <label for="subtask-${task.id}-${i}" class="${sub.completed ? 'line-through text-gray-500' : ''}">${sub.text}</label>
                            </div>`).join('')}</div>` : '';
                        
                        const canComplete = !task.subtasks || task.subtasks.length === 0 || task.subtasks.every(st => st.completed);
                        
                        return `
                        <div data-task-id="${task.id}" class="card !transform-none p-3 rounded-lg flex flex-col items-stretch ${task.isNew ? 'anim-fade-in' : ''} ${isCompletedToday ? 'opacity-50' : ''} priority-${task.priority || 'medium'}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-semibold ${isCompletedToday ? 'line-through' : ''}">${task.name}</h4>
                                    <div class="mt-1">
                                         <span class="text-xs font-bold text-accent-primary bg-blue-500/10 px-2 py-1 rounded-full">${task.xp} XP</span>
                                    </div>
                                </div>
                                <div class="flex gap-1 flex-shrink-0 pl-2">
                                    <button data-id="${task.id}" data-action="edit-task" class="p-2 rounded-full hover:bg-blue-500/20"><i data-lucide="pencil" class="w-4 h-4 text-blue-400" style="pointer-events:none;"></i></button>
                                    <button data-id="${task.id}" data-action="delete-task" class="p-2 rounded-full hover:bg-red-500/20"><i data-lucide="trash-2" class="w-4 h-4 text-red-400" style="pointer-events:none;"></i></button>
                                    <button data-id="${task.id}" data-action="complete-task" class="btn-interactive bg-green-600 hover:bg-green-700 text-white font-bold p-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" ${isCompletedToday || !canComplete ? 'disabled' : ''}>
                                        <i data-lucide="check" class="w-4 h-4" style="pointer-events:none;"></i>
                                    </button>
                                </div>
                            </div>
                            ${subtasksHtml}
                        </div>`;
                    }).join('');
                },
                
                updateStreak() {
                    const today = new Date().toDateString();
                    if (this.state.player.lastCompletedDate === today) return null;

                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);

                    if (this.state.player.lastCompletedDate === yesterday.toDateString()) {
                        this.state.player.streak++;
                    } else {
                        this.state.player.streak = 1;
                    }
                    this.state.player.lastCompletedDate = today;

                    const streakBonusXP = 10 * this.state.player.streak;
                    const streakBonusGold = 5 * this.state.player.streak;
                    this.state.player.xp += streakBonusXP;
                    this.state.player.gold += streakBonusGold;

                    return { newStreak: this.state.player.streak, bonusXP: streakBonusXP, bonusGold: streakBonusGold };
                },
                
                generateBounties() {
                    const today = new Date().toDateString();
                    if (this.state.bounties.lastDate === today) return;

                    // It's a new day, reset daily stats and pick new bounties
                    this.state.player.stats.questsCompletedToday = 0;
                    this.state.player.stats.goldEarnedToday = 0;
                    this.state.bounties.lastDate = today;
                    this.state.bounties.completedToday = {};
                    
                    const shuffled = this.config.bountyPool.sort(() => 0.5 - Math.random());
                    this.state.bounties.active = shuffled.slice(0, 2).map(b => b.id);
                },

                checkBounties() {
                    this.state.bounties.active.forEach(bountyId => {
                        if (this.state.bounties.completedToday[bountyId]) return;

                        const bounty = this.config.bountyPool.find(b => b.id === bountyId);
                        if (bounty && bounty.condition(this.state)) {
                            this.state.player.xp += bounty.reward.xp;
                            this.state.player.gold += bounty.reward.gold;
                            this.state.bounties.completedToday[bountyId] = true;
                            this.showToast(" Bounty Complete!", `${bounty.name}<br>+${bounty.reward.xp} XP, +${bounty.reward.gold} G`, 'levelup');
                            this.audio.playAchievement();
                        }
                    });
                },
                
                 checkHeroJourney() {
                    this.config.heroJourney.forEach(chapter => {
                        if (!this.state.unlockedJourneyChapters[chapter.id] && chapter.condition(this.state)) {
                            this.state.unlockedJourneyChapters[chapter.id] = new Date().toLocaleDateString();
                            if (chapter.reward.type === 'title_unlock') {
                                this.state.character.title = chapter.reward.value;
                            }
                            if (chapter.reward.type === 'theme_unlock') {
                                if (!this.state.unlockedThemes.includes(chapter.reward.value)) {
                                    this.state.unlockedThemes.push(chapter.reward.value);
                                }
                            }
                            // Special case for the final chapter
                            if(chapter.id === 'hj26') {
                                this.state.character.title = 'The Legend';
                            }
                            this.showToast(" Hero's Journey", `Chapter Unlocked: ${chapter.name}`, "levelup");
                            this.audio.playAchievement();
                        }
                    });
                },
                
                renderCharacter() {
                    this.dom.characterNameInput.value = this.state.character.name;
                    this.dom.characterTitle.textContent = this.state.character.title || '';
                    this.dom.avatarDisplay.style.backgroundImage = `url(${this.config.avatars[this.state.character.avatar]})`;
                    this.dom.characterClass.textContent = this.state.character.class;
                },
                
                renderSettings() {
                    const soundOn = this.state.settings.sound;
                    const themeOptions = this.state.unlockedThemes.map(theme => 
                        `<option value="${theme}" ${this.state.settings.theme === theme ? 'selected' : ''}>${theme.charAt(0).toUpperCase() + theme.slice(1)}</option>`
                    ).join('');

                    this.dom.settingsModal.innerHTML = `
                    <div class="card p-6 rounded-lg shadow-2xl max-w-md w-full mx-4 anim-fade-in">
                        <div class="flex justify-between items-center card-header pb-3 mb-4">
                            <h2 class="text-2xl">Settings</h2>
                            <button id="settingsCloseBtn" class="p-2 rounded-full hover:bg-themed">&times;</button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label for="theme-select" class="block text-sm font-medium mb-2">Theme</label>
                                <select id="theme-select" class="w-full p-2 bg-themed rounded-lg">
                                    ${themeOptions}
                                </select>
                            </div>
                            <div class="flex justify-between items-center bg-themed p-2 rounded-lg">
                                <label for="sound-toggle" class="text-sm font-medium">Sound Effects</label>
                                <button id="sound-toggle" class="px-3 py-1 text-sm rounded-md ${soundOn ? 'bg-green-600' : 'bg-gray-600'} btn-interactive">${soundOn ? 'On' : 'Off'}</button>
                            </div>
                            <div class="flex gap-2">
                                <button id="export-data-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition btn-interactive">Export Data</button>
                                <button id="reset-data-btn" class="w-full bg-red-800 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition btn-interactive">Reset Data</button>
                            </div>
                        </div>
                    </div>`;
                    document.getElementById('theme-select').addEventListener('change', e => this.handleThemeChange(e));
                    document.getElementById('export-data-btn').addEventListener('click', () => this.exportDataToCSV());
                    document.getElementById('reset-data-btn').addEventListener('click', () => this.handleResetData());
                    document.getElementById('sound-toggle').addEventListener('click', e => this.handleSoundToggle(e));
                },

                handleSoundToggle(e) {
                    this.state.settings.sound = !this.state.settings.sound;
                    const button = e.target;
                    button.textContent = this.state.settings.sound ? 'On' : 'Off';
                    button.classList.toggle('bg-green-600', this.state.settings.sound);
                    button.classList.toggle('bg-gray-600', !this.state.settings.sound);
                    this.saveStateDebounced();
                },

                renderAvatarModal() {
                    const availableAvatars = {...this.config.avatars};
                    if (!this.state.unlockedJourneyChapters['hj3']) delete availableAvatars.gold_dragon;
                    if (!this.state.unlockedJourneyChapters['hj10']) delete availableAvatars.warrior;
                    if (!this.state.unlockedJourneyChapters['hj15']) delete availableAvatars.sorcerer;
                    if (!this.state.unlockedJourneyChapters['hj19']) delete availableAvatars.master;
                    if (!this.state.unlockedJourneyChapters['hj26']) delete availableAvatars.legend;

                    const content = Object.keys(availableAvatars).map(key => {
                        const classBonus = this.config.classBonuses[key] || { description: 'A legendary hero.'};
                        return `
                        <div class="text-center">
                            <button data-avatar="${key}" class="avatar-select-button p-2 bg-themed rounded-lg border-2 border-transparent ${this.state.character.avatar === key ? 'selected' : ''}">
                                <img src="${this.config.avatars[key]}" class="w-16 h-16" style="image-rendering: pixelated;">
                            </button>
                            <p class="text-sm font-bold capitalize mt-2">${key.replace('_', ' ')}</p>
                            <p class="text-xs text-gray-400 mt-1">${classBonus.description}</p>
                        </div>`
                    }).join('');
                    
                    this.dom.avatarModal.innerHTML = `
                    <div class="card p-6 rounded-lg shadow-2xl max-w-lg w-full mx-4 anim-fade-in">
                        <div class="flex justify-between items-center card-header pb-3 mb-4">
                            <h2 class="text-2xl">Choose Class</h2>
                            <button id="avatarCloseBtn" class="p-2 rounded-full hover:bg-themed">&times;</button>
                        </div>
                        <div class="grid grid-cols-3 gap-4">${content}</div>
                    </div>`;
                },
                
                handleNameChange(e) { this.state.character.name = e.target.value; this.saveStateDebounced(); },
                
                handleAddReward(e) {
                    e.preventDefault();
                    const form = this.dom.addRewardForm;
                    const name = form.querySelector('#reward-name').value.trim();
                    const cost = parseInt(form.querySelector('#reward-cost').value);
                    if (name && cost > 0) {
                        const newReward = { id: Date.now(), name, cost };
                        this.state.shop.push(newReward);
                        this.render();
                        this.audio.playCoin();
                        form.reset();
                    }
                },
                
                buyReward(rewardId) {
                    const reward = this.state.shop.find(r => r.id === rewardId);
                    if (reward && this.state.player.gold >= reward.cost) {
                        this.state.player.gold -= reward.cost;
                        this.state.player.stats.totalGoldSpent += reward.cost;
                        this.state.player.stats.rewardsClaimed++;
                        this.showToast(`Purchased "${reward.name}"!`, '', 'success');
                        this.audio.playCoin();
                        this.render();
                    } else {
                        this.showToast('Not enough gold!', '', 'error');
                    }
                },
                
                buyBlackMarketItem(itemId) {
                    const item = this.config.blackMarketItems.find(i => i.id === itemId);
                    if (!item) return;

                    if (this.state.player.gold < item.cost) {
                        this.showToast("Not enough gold!", '', 'error');
                        return;
                    }
                    
                    if (item.duration === Infinity && this.state.player.activeBuffs.some(b => b.id === itemId)) {
                         this.showToast("You already own this permanent item.", '', 'error');
                         return;
                    }

                    this.state.player.gold -= item.cost;
                    
                    const expiresAt = item.duration === Infinity ? null : Date.now() + item.duration * 60 * 60 * 1000;
                    this.state.player.activeBuffs.push({ id: item.id, expiresAt });
                    
                    this.showToast(`Purchased ${item.name}!`, item.desc, 'success');
                    this.audio.playCoin();
                    this.render();
                },

                checkActiveBuffs() {
                    const now = Date.now();
                    this.state.player.activeBuffs = this.state.player.activeBuffs.filter(buff => {
                        return buff.expiresAt === null || buff.expiresAt > now;
                    });
                },

                animateRewardGain(element, text, type) {
                    if (!element) return;
                    const rect = element.getBoundingClientRect();
                    const flyUp = document.createElement('div');
                    flyUp.textContent = text;
                    flyUp.className = 'reward-fly-up';
                    if (type === 'xp') {
                        flyUp.style.backgroundColor = 'var(--accent-primary)';
                        flyUp.style.color = 'var(--text-primary)';
                    } else { // gold
                        flyUp.style.backgroundColor = 'var(--accent-gold)';
                        flyUp.style.color = '#1F2937'; // Dark text for gold bg
                    }
                    flyUp.style.left = `${rect.left + rect.width / 2 - 20}px`;
                    flyUp.style.top = `${rect.top + rect.height / 2 - 10}px`;
                    document.body.appendChild(flyUp);
                    flyUp.addEventListener('animationend', () => flyUp.remove());
                },
                
                renderFilterOptions() {
                    const categories = [...new Set(this.state.tasks.map(t => t.category))];
                    const currentFilter = this.state.uiSettings.filterCategory;
                    
                    this.dom.filterCategory.innerHTML = `
                        <option value="all">All Categories</option>
                        ${categories.map(cat => `<option value="${cat}" ${cat === currentFilter ? 'selected' : ''}>${cat}</option>`).join('')}
                    `;
                    this.dom.sortTasks.value = this.state.uiSettings.sortBy;
                },

                isQuestActiveToday(task) {
                    if (!task.recurrence || task.recurrence.type === 'none') {
                        return true; // One-time tasks are always active until completed
                    }
                    const todayStr = new Date().toISOString().split('T')[0];
                    if (task.lastCompleted === todayStr) {
                        return false; // Already completed today
                    }
                    // More complex recurrence logic would go here
                    return true;
                },

                renderSkills() {
                    if (Object.keys(this.state.skills).length === 0) {
                        this.dom.skillsList.innerHTML = `<div class="empty-state-container text-sm text-gray-400">
                            <i data-lucide="book-open" class="w-12 h-12 mb-2"></i>
                            <h3 class="font-semibold">No Skills Yet</h3><p>Complete quests to discover and level up skills!</p></div>`;
                        return;
                    }
                    this.dom.skillsList.innerHTML = Object.entries(this.state.skills).map(([name, skill]) => {
                        const reqXp = this.config.xpForLevel(skill.level);
                        const progress = (skill.xp / reqXp) * 100;
                        return `
                        <div class="skill-item p-2 rounded-lg border border-transparent transition-colors">
                            <div class="flex justify-between items-baseline mb-1">
                                <div class="flex items-center gap-2">
                                    <h4 class="font-semibold text-base">${name}</h4>
                                </div>
                                <span class="text-sm font-bold">Lvl ${skill.level}</span>
                            </div>
                            <div class="progress-bar-bg w-full h-3 rounded-full overflow-hidden">
                                <div class="progress-bar-fill skill-bar h-full" style="width: ${progress}%;"></div>
                            </div>
                        </div>`;
                    }).join('');
                    this.dom.skillSuggestions.innerHTML = Object.keys(this.state.skills).map(skill => `<option value="${skill}"></option>`).join('');
                },
                renderHeroJourney() {
                    let nextChapterFound = false;
                    const journeyHtml = this.config.heroJourney.map(chapter => {
                        const isUnlocked = !!this.state.unlockedJourneyChapters[chapter.id];
                        let status = '';
                        if (isUnlocked) {
                            status = 'completed';
                        } else if (!nextChapterFound) {
                            status = 'next';
                            nextChapterFound = true;
                        } else {
                            status = 'locked';
                        }

                        return `
                        <div class="journey-item ${status}">
                            <div class="journey-icon">
                                <i data-lucide="award" class="w-4 h-4"></i>
                            </div>
                            <div class="journey-content">
                                <h4 class="font-semibold text-base">${chapter.name}</h4>
                                <p class="text-sm">${chapter.desc}</p>
                                ${isUnlocked ? `<p class="text-xs text-green-400 font-bold">Reward: ${chapter.rewardDesc}</p>` : ''}
                            </div>
                        </div>`;
                    }).join('');
                    this.dom.heroJourneyList.innerHTML = `<div class="relative">${journeyHtml}</div>`;
                },

                 renderShop() {
                    this.renderBlackMarket();
                    if (this.state.shop.length === 0) {
                        this.dom.shopList.innerHTML = `<div class="empty-state-container text-sm text-gray-400">
                            <i data-lucide="store" class="w-12 h-12 mb-2"></i>
                            <h3 class="font-semibold">Shop is Empty</h3><p>Add your own rewards to the shop below.</p></div>`;
                        return;
                    }
                    this.dom.shopList.innerHTML = this.state.shop.map(item => `
                        <div data-reward-id="${item.id}" class="bg-themed p-2 rounded-lg flex justify-between items-center anim-fade-in">
                            <div><p>${item.name}</p><p class="text-sm gold-text font-semibold">${item.cost} G</p></div>
                            <div class="flex items-center gap-1">
                                <button data-id="${item.id}" data-action="edit-reward" class="p-2 rounded-full hover:bg-blue-500/20"><i data-lucide="pencil" class="w-4 h-4 text-blue-400"></i></button>
                                <button data-id="${item.id}" data-action="delete-reward" class="p-2 rounded-full hover:bg-red-500/20"><i data-lucide="trash-2" class="w-4 h-4 text-red-400"></i></button>
                                <button data-id="${item.id}" data-action="buy-reward" class="btn-interactive bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold p-2 rounded-lg" ${this.state.player.gold < item.cost ? 'disabled' : ''}><i data-lucide="shopping-cart" class="w-5 h-5"></i></button>
                            </div>
                        </div>`).join('');
                },

                renderBlackMarket() {
                    let html = `<h3 class="text-lg mb-2">Black Market</h3>`;
                    html += this.config.blackMarketItems.map(item => {
                        const hasBuff = this.state.player.activeBuffs.some(b => b.id === item.id);
                        const canAfford = this.state.player.gold >= item.cost;
                        const isDisabled = hasBuff || !canAfford;
                        return `<div class="bg-themed p-3 rounded-lg mb-2 border-l-4 border-red-500">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-semibold text-base flex items-center gap-2"><i data-lucide="${item.icon}" class="w-4 h-4"></i> ${item.name}</h4>
                                    <p class="text-xs text-text-secondary">${item.desc}</p>
                                    <p class="text-sm gold-text font-semibold">${item.cost} G</p>
                                </div>
                                <button data-action="buy-black-market-item" data-id="${item.id}" class="btn-interactive bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" ${isDisabled ? 'disabled' : ''}>
                                    ${hasBuff ? 'Owned' : 'Buy'}
                                </button>
                            </div>
                        </div>`;
                    }).join('');
                    this.dom.blackMarketSection.innerHTML = html;
                },
                
                renderBountyBoard() {
                    let html = `<h2 class="text-2xl mb-4 card-header pb-3">Bounty Board</h2>`;
                    if (this.state.bounties.active.length === 0) {
                        html += `<div class="empty-state-container text-sm text-gray-400"><p>No bounties today. Check back tomorrow!</p></div>`;
                    } else {
                        html += '<div class="space-y-3">';
                        html += this.state.bounties.active.map(bountyId => {
                            const bounty = this.config.bountyPool.find(b => b.id === bountyId);
                            if (!bounty) return '';
                            const isCompleted = this.state.bounties.completedToday[bountyId];
                            return `<div class="bg-themed p-3 rounded-lg border-l-4 border-yellow-500 ${isCompleted ? 'opacity-50' : ''}">
                                <h4 class="font-semibold text-base">${bounty.name}</h4>
                                <p class="text-sm text-text-secondary">${bounty.desc}</p>
                                <p class="text-sm mt-1">Reward: <span class="text-accent-primary font-semibold">${bounty.reward.xp} XP</span> &bull; <span class="gold-text font-semibold">${bounty.reward.gold} G</span></p>
                                ${isCompleted ? '<p class="text-xs text-green-400 font-bold mt-1">COMPLETED</p>' : ''}
                            </div>`;
                        }).join('');
                        html += '</div>';
                    }
                    this.dom.bountyBoardCard.innerHTML = html;
                },

                renderActiveBuffs() {
                    this.checkActiveBuffs();
                    this.dom.activeBuffsContainer.innerHTML = this.state.player.activeBuffs.map(buff => {
                        const item = this.config.blackMarketItems.find(i => i.id === buff.id);
                        if (!item) return '';

                        const expiresIn = buff.expiresAt ? `Expires: ${new Date(buff.expiresAt).toLocaleTimeString()}` : 'Permanent';

                        return `<div class="tooltip text-xl">
                            <i data-lucide="${item.icon}" class="w-5 h-5"></i>
                            <span class="tooltiptext">${item.name}<br>${expiresIn}</span>
                        </div>`;
                    }).join('');
                },

                renderPlayerProfile() {
                    const { questsCompleted, totalGoldEarned, totalXpGained, totalGoldSpent, rewardsClaimed } = this.state.player.stats;
                    this.dom.playerProfileStats.innerHTML = `
                        <div class="grid grid-cols-1 gap-1">
                           ${this.createStatItem('list-checks', 'Quests Completed', questsCompleted)}
                           ${this.createStatItem('star', 'Total XP Gained', `${Math.round(totalXpGained)} XP`)}
                           ${this.createStatItem('circle-dollar-sign', 'Total Gold Earned', `<span class="gold-text">${Math.round(totalGoldEarned)} G</span>`)}
                           ${this.createStatItem('wallet', 'Total Gold Spent', `${totalGoldSpent || 0} G</span>`)}
                           ${this.createStatItem('treasure-chest', 'Rewards Claimed', rewardsClaimed || 0)}
                        </div>`;
                },

                createStatItem(iconName, tooltipText, value) {
                    return `
                        <div class="flex items-center gap-3 p-2 rounded-md hover:bg-white/5 transition-colors">
                            <div class="tooltip">
                                <i data-lucide="${iconName}" class="w-5 h-5 text-gray-400"></i>
                                <span class="tooltiptext">${tooltipText}</span>
                            </div>
                            <span class="font-bold text-right flex-grow">${value}</span>
                        </div>`;
                },
                
                handleThemeChange(e) { this.state.settings.theme = e.target.value; this.applyTheme(); this.saveStateDebounced(); },
                
                applyTheme() { 
                    document.documentElement.setAttribute('data-theme', this.state.settings.theme); 
                    this.renderStatsChart(); 
                    this.renderCategoryDonutChart();
                    this.renderSkillRadarChart();
                    this.renderTimeOfDayChart();
                },
                
                handleResetData() {
                    this.showModal('confirmationModal', 'Reset All Data?', 'This will permanently delete all progress. This action cannot be undone.', async () => {
                        this.state = this.getDefaultState();
                        this.generateBounties();
                        await this.saveStateToFirestore(); // Save the reset state
                        this.hideModal('confirmationModal');
                        this.showToast('All data has been reset.', '', 'success');
                        this.render(); // Re-render everything with the fresh state
                    });
                },

                exportDataToCSV() {
                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "Category,Name,Value\n";
                    // Player Stats
                    Object.entries(this.state.player.stats).forEach(([key, value]) => {
                        csvContent += `Player Stat,"${key}",${value}\n`;
                    });
                    // Active Quests
                    this.state.tasks.forEach(task => {
                        csvContent += `Active Quest,"${task.name.replace(/"/g, '""')}","${task.category}, ${task.xp} XP"\n`;
                    });
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "task-quest-data.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },

                deleteTask(taskId) {
                    this.state.tasks = this.state.tasks.filter(t => t.id !== taskId);
                    this.render();
                    this.hideModal('confirmationModal');
                },

                deleteReward(rewardId) {
                    this.state.shop = this.state.shop.filter(r => r.id !== rewardId);
                    this.render();
                    this.hideModal('confirmationModal');
                },

                showModal(modalId, ...args) {
                    const modal = document.getElementById(modalId);
                    switch (modalId) {
                        case 'settingsModal': this.renderSettings(); break;
                        case 'avatarModal': this.renderAvatarModal(); break;
                        case 'questLogModal': this.renderQuestLog(); break;
                        case 'confirmationModal': {
                            const [title, message, onConfirm] = args;
                            modal.innerHTML = `<div class="card p-6 rounded-lg shadow-2xl max-w-sm w-full mx-4 anim-fade-in"><h2 class="text-xl mb-4">${title || 'Confirm'}</h2><p class="text-secondary mb-6">${message || 'Are you sure?'}</p><div class="flex justify-end gap-4"><button id="modalCancelBtn" class="bg-gray-600 hover:bg-gray-700 font-semibold py-2 px-4 rounded-lg btn-interactive">Cancel</button><button id="modalConfirmBtn" class="bg-red-600 hover:bg-red-700 font-semibold py-2 px-4 rounded-lg btn-interactive">Confirm</button></div></div>`;
                            modal.querySelector('#modalConfirmBtn').onclick = () => onConfirm();
                            break;
                        }
                    }
                    modal.classList.add('flex');
                    setTimeout(() => modal.classList.add('opacity-100'), 10);
                },

                hideModal(modalId) {
                    let modal = document.getElementById(modalId);
                    modal.classList.remove('opacity-100');
                    modal.addEventListener('transitionend', () => modal.classList.remove('flex'), { once: true });
                },

                showEditModal(type, id) {
                    this.state.editing = { type, id };
                    let item, formHtml;
                    const commonClasses = "w-full p-2 bg-themed rounded-lg";
                    if (type === 'task') {
                        item = this.state.tasks.find(t => t.id === id);
                        formHtml = `<div><label for="edit-name" class="block text-sm mb-1">Quest Name</label><input type="text" id="edit-name" value="${item.name}" required class="${commonClasses}"></div><div><label for="edit-category" class="block text-sm mb-1">Category</label><input type="text" id="edit-category" value="${item.category}" list="skill-suggestions" required class="${commonClasses}"></div><div><label for="edit-xp" class="block text-sm mb-1">XP Reward</label><input type="number" id="edit-xp" value="${item.xp}" min="10" step="10" required class="${commonClasses}"></div>`;
                    } else { // reward
                        item = this.state.shop.find(r => r.id === id);
                        formHtml = `<div><label for="edit-name" class="block text-sm mb-1">Reward Name</label><input type="text" id="edit-name" value="${item.name}" required class="${commonClasses}"></div><div><label for="edit-cost" class="block text-sm mb-1">Gold Cost</label><input type="number" id="edit-cost" value="${item.cost}" min="1" required class="${commonClasses}"></div>`;
                    }
                    formHtml += `<div class="flex justify-end gap-4 mt-6"><button type="button" id="editCancelBtn" class="bg-gray-600 hover:bg-gray-700 font-semibold py-2 px-4 rounded-lg btn-interactive">Cancel</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 font-semibold py-2 px-4 rounded-lg btn-interactive">Save</button></div>`;
                    
                    const modal = document.getElementById('editModal');
                    modal.innerHTML = `<div class="card p-6 rounded-lg shadow-2xl max-w-md w-full mx-4 anim-fade-in"><h2 class="text-2xl mb-4">Edit Item</h2><form id="edit-form" class="space-y-4">${formHtml}</form></div>`;
                    this.showModal('editModal');
                },

                showToast(title, message = "", type = "default") {
                    const toast = document.createElement("div");
                    toast.className = `toast p-4 rounded-lg shadow-xl transform translate-y-4 opacity-0 transition-all duration-300 toast-${type}`;
                    toast.innerHTML = `<p class="font-semibold">${title}</p>${message ? `<p class="text-sm mt-1">${message}</p>` : ""}`;
                    this.dom.toastContainer.appendChild(toast);
                    setTimeout(() => { toast.classList.remove("translate-y-4", "opacity-0"); }, 10);
                    setTimeout(() => {
                        toast.classList.add("translate-y-4", "opacity-0");
                        toast.addEventListener("transitionend", () => toast.remove(), { once: true });
                    }, 4000);
                },

                ensureSkillExists(category) {
                    if (!this.state.skills[category]) {
                        this.state.skills[category] = { level: 1, xp: 0 };
                    }
                },
                
                toggleAdvancedOptions() {
                    const container = this.dom.advancedOptionsContainer;
                    const isOpen = container.classList.toggle('open');
                    this.dom.toggleAdvancedBtn.textContent = isOpen ? 'Hide Advanced Options' : 'Show Advanced Options';
                },

                handleFilterChange(e) { this.state.uiSettings.filterCategory = e.target.value; this.renderTasks(); },
                handleSortChange(e) { this.state.uiSettings.sortBy = e.target.value; this.renderTasks(); },

                switchMobileTab(tabName) {
                    this.state.uiSettings.activeMobileTab = tabName;
                    Object.values(this.dom.mobilePanels).forEach(panel => panel.classList.add('hidden'));
                    this.dom.mobilePanels[tabName].classList.remove('hidden');
                    this.dom.mobileTabBar.querySelectorAll('.mobile-tab').forEach(button => {
                        button.classList.toggle('active', button.dataset.tab === tabName);
                    });
                },

                switchProfileTab(tabName) {
                    Object.values(this.dom.profileTabContents).forEach(content => content.style.display = 'none');
                    this.dom.profileTabs.forEach(tab => tab.classList.remove('active'));

                    if (this.dom.profileTabContents[tabName]) {
                        this.dom.profileTabContents[tabName].style.display = 'block';
                    }
                    const activeTab = document.querySelector(`.profile-tab[data-tab="${tabName}"]`);
                    if(activeTab) activeTab.classList.add('active');
                },

                renderStatsChart() {
                    if (this.statsChart) this.statsChart.destroy();
                    const labels = [];
                    const data = [];
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        labels.push(date.toLocaleDateString(undefined, { weekday: "short" }));
                        const count = this.state.completedTasks.filter(t => new Date(t.completedAt).toDateString() === date.toDateString()).length;
                        data.push(count);
                    }
                    const isLight = this.state.settings.theme === 'light';
                    const gridColor = isLight ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
                    const textColor = isLight ? '#4B5563' : '#9CA3AF';
                    this.statsChart = new Chart(this.dom.statsChartCanvas, {
                        type: 'bar',
                        data: { labels, datasets: [{ label: "Quests Completed", data, backgroundColor: "rgba(59, 130, 246, 0.5)", borderColor: "rgba(59, 130, 246, 1)", borderWidth: 1 }] },
                        options: { scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor, stepSize: 1 } }, x: { grid: { color: gridColor }, ticks: { color: textColor } } }, plugins: { legend: { display: false } }, maintainAspectRatio: false }
                    });
                },

                renderCategoryDonutChart() {
                    if (this.categoryChart) this.categoryChart.destroy();
                    const categoryCounts = this.state.completedTasks.reduce((acc, task) => {
                        acc[task.category] = (acc[task.category] || 0) + 1;
                        return acc;
                    }, {});
                    const labels = Object.keys(categoryCounts);
                    const data = Object.values(categoryCounts);
                    if (labels.length === 0) return;
                    
                    const isLight = this.state.settings.theme === 'light';
                    const textColor = isLight ? '#4B5563' : '#9CA3AF';
                    const backgroundColors = ['#3B82F6', '#8B5CF6', '#10B981', '#F97316', '#EF4444', '#EAB308', '#6366F1'];

                    this.categoryChart = new Chart(this.dom.categoryDonutChartCanvas, {
                        type: 'doughnut',
                        data: {
                            labels,
                            datasets: [{
                                label: 'Quests by Category',
                                data,
                                backgroundColor: backgroundColors,
                                borderColor: 'var(--bg-primary)',
                                borderWidth: 2,
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor, boxWidth: 12, padding: 15 } } } }
                    });
                },

                renderSkillRadarChart() {
                    if (this.skillRadarChart) this.skillRadarChart.destroy();
                    const skillXp = this.state.completedTasks.reduce((acc, task) => {
                        acc[task.category] = (acc[task.category] || 0) + task.finalXp;
                        return acc;
                    }, {});
                    const labels = Object.keys(skillXp);
                    if (labels.length < 3) return; // Radar charts need at least 3 points
                    const data = Object.values(skillXp);

                    const isLight = this.state.settings.theme === 'light';
                    const gridColor = isLight ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
                    const textColor = isLight ? '#4B5563' : '#9CA3AF';

                    this.skillRadarChart = new Chart(this.dom.skillRadarChartCanvas, {
                        type: 'radar',
                        data: {
                            labels,
                            datasets: [{
                                label: 'Total XP Earned',
                                data,
                                backgroundColor: 'rgba(139, 92, 246, 0.2)',
                                borderColor: 'rgba(139, 92, 246, 1)',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: { r: { angleLines: { color: gridColor }, grid: { color: gridColor }, pointLabels: { color: textColor }, ticks: { display: false } } },
                            plugins: { legend: { display: false } }
                        }
                    });
                },

                renderTimeOfDayChart() {
                    if (this.timeOfDayChart) this.timeOfDayChart.destroy();
                    const hourlyCounts = Array(24).fill(0);
                    this.state.completedTasks.forEach(task => {
                        const hour = new Date(task.completedAt).getHours();
                        hourlyCounts[hour]++;
                    });

                    const isLight = this.state.settings.theme === 'light';
                    const gridColor = isLight ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
                    const textColor = isLight ? '#4B5563' : '#9CA3AF';
                    const labels = Array.from({ length: 24 }, (_, i) => `${i % 12 === 0 ? 12 : i % 12}${i < 12 ? 'a' : 'p'}`);

                    this.timeOfDayChart = new Chart(this.dom.timeOfDayChartCanvas, {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [{
                                label: 'Quests Completed',
                                data: hourlyCounts,
                                backgroundColor: 'rgba(249, 115, 22, 0.5)',
                                borderColor: 'rgba(249, 115, 22, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                             scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor, stepSize: 1 } }, x: { grid: { color: gridColor }, ticks: { color: textColor, autoSkip: true, maxTicksLimit: 12 } } }, 
                             plugins: { legend: { display: false } }
                        }
                    });
                },

                renderProductivityHeatmap() {
                    const container = this.dom.productivityHeatmapContainer;
                    container.innerHTML = '';
                    const completionMap = new Map();
                    this.state.completedTasks.forEach(task => {
                        const dateStr = new Date(task.completedAt).toISOString().split('T')[0];
                        completionMap.set(dateStr, (completionMap.get(dateStr) || 0) + 1);
                    });

                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(endDate.getDate() - 34); // Approx 5 weeks

                    for (let i = 0; i < 35; i++) {
                        const day = new Date(startDate);
                        day.setDate(startDate.getDate() + i);
                        const dateStr = day.toISOString().split('T')[0];
                        const count = completionMap.get(dateStr) || 0;
                        
                        const cell = document.createElement('div');
                        cell.className = 'w-5 h-5 rounded-sm tooltip';
                        
                        let colorClass = 'bg-gray-700'; // Default for no completions
                        if (count > 0 && count <= 2) colorClass = 'bg-blue-800';
                        else if (count > 2 && count <= 4) colorClass = 'bg-blue-600';
                        else if (count > 4) colorClass = 'bg-blue-400';
                        cell.classList.add(colorClass);

                        cell.innerHTML = `<span class="tooltiptext">${dateStr}: ${count} quests</span>`;
                        container.appendChild(cell);
                    }
                },
                
                renderQuestLog() {
                    const content = this.state.completedTasks.length === 0 ? '<p class="text-gray-400 text-center">No completed quests yet.</p>' : [...this.state.completedTasks].map(task => {
                        const hasRewardDetails = task.finalXp !== undefined;
                        const rewardDetailsHtml = hasRewardDetails ? `
                            <div class="text-xs space-y-1 mt-2 pt-2 border-t border-white/10">
                                ${task.rewardsLogHtml || ''}
                                <p>Base Reward: <span class="font-semibold">${task.xp} XP</span> &bull; <span class="font-semibold gold-text">${this.config.goldForTask(task.xp)} G</span></p>
                                <p class="font-bold">Total Gained: <span class="text-accent-primary">${Math.round(task.finalXp)} XP</span> &bull; <span class="gold-text">${Math.round(task.goldGained)} G</span></p>
                            </div>
                        ` : '';

                        return `
                        <div class="bg-themed p-3 rounded-md">
                            <div>
                                <h4 class="font-semibold">${task.name} <span class="text-xs text-gray-400">- ${task.category}</span></h4>
                                <p class="text-xs text-gray-500">Completed: ${new Date(task.completedAt).toLocaleString()}</p>
                            </div>
                            ${rewardDetailsHtml}
                        </div>`
                    }).join("");
                        
                    this.dom.questLogModal.innerHTML = `
                    <div class="card p-6 rounded-lg shadow-2xl max-w-2xl w-full mx-4 anim-fade-in flex flex-col">
                        <div class="flex justify-between items-center card-header pb-3 mb-4">
                            <h2 class="text-2xl">Completed Quest Log</h2>
                            <button id="questLogCloseBtn" class="p-2 rounded-full hover:bg-themed">&times;</button>
                        </div>
                        <div class="space-y-2 overflow-y-auto max-h-[60vh] pr-2 scrollable-content">${content}</div>
                    </div>`;
                },

                renderRecurrenceOptions(type) {
                    const container = this.dom.recurrenceOptions;
                    if (type === 'weekly') {
                        container.innerHTML = `<div class="text-sm"><label class="block mb-2">Repeat on:</label><div class="flex justify-around bg-themed p-1 rounded-lg">${['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((day, i) => `<label class="flex items-center justify-center w-8 h-8 rounded-full cursor-pointer"><input type="checkbox" name="recurrence-weekly-day" value="${i}" class="sr-only peer"><span class="peer-checked:bg-accent-primary peer-checked:text-white rounded-full w-full h-full flex items-center justify-center">${day}</span></label>`).join('')}</div></div>`;
                    } else if (type === 'monthly') {
                        container.innerHTML = `<div class="text-sm"><label for="recurrence-monthly-day" class="block mb-2">Repeat on day:</label><input type="number" id="recurrence-monthly-day" min="1" max="31" value="1" class="w-full p-2 bg-themed rounded-lg"></div>`;
                    } else {
                        container.innerHTML = '';
                    }
                },

                handleAddSubtask() {
                    const name = this.dom.subtaskNameInput.value.trim();
                    if (name) {
                        this.tempSubtasks.push({ text: name, completed: false });
                        this.renderTempSubtasks();
                        this.dom.subtaskNameInput.value = '';
                        this.dom.subtaskNameInput.focus();
                    }
                },

                renderTempSubtasks() {
                    this.dom.subtasksContainer.innerHTML = this.tempSubtasks.map((sub, index) => `<div class="bg-gray-800/50 p-2 rounded-md flex justify-between items-center text-sm"><span>${sub.text}</span><button type="button" data-index="${index}" data-action="delete-temp-subtask" class="text-red-400 hover:text-red-300">&times;</button></div>`).join('');
                },

                handleDeleteTempSubtask(e) {
                    if (e.target.dataset.action === 'delete-temp-subtask') {
                        const index = Number(e.target.dataset.index);
                        this.tempSubtasks.splice(index, 1);
                        this.renderTempSubtasks();
                    }
                },

                toggleSubtask(taskId, subtaskIndex) {
                    const task = this.state.tasks.find(t => t.id === taskId);
                    if (task && task.subtasks[subtaskIndex]) {
                        task.subtasks[subtaskIndex].completed = !task.subtasks[subtaskIndex].completed;
                        this.render();
                    }
                },

                 handleAvatarSelect(avatar) {
                    this.state.character.avatar = avatar;
                    // FIX: Ensure class only changes if the avatar is a valid class, not a special one
                    if (this.config.classBonuses[avatar]) {
                        this.state.character.class = avatar;
                    }
                    this.render();
                    this.hideModal('avatarModal');
                }
            };

            TaskQuest.init();
        });
    </script>
</body>
</html>

